{"version":3,"sources":["scripts/main.js"],"names":["this","MyOD","Backbone","Marionette","Application","on","searchModel","Models","SearchModel","layout","Main","Layout","history","setClasses","start","pushState","root","navigate","trigger","route","options","search","getRoute","navigateDataset","datasetId","navigate404","replace","queryStringToObject","result","q","getFragment","split","pairs","_","each","pair","decodeURIComponent","getBloodhound","bloodhound","Bloodhound","datumTokenizer","tokenizers","obj","whitespace","queryTokenizer","limit","remote","url","config","api","rateLimitWait","query","filter","response","data","onBeforeDestroy","stop","module","Utils","App","$","MapManager","Object","extend","initialize","bindAll","globalChannel","Wreqr","radio","channel","_loadDojo","reqres","setHandler","updateStyle","dfd","Deferred","dojoReady","promise","window","dojo","resolve","include","require","map","destroy","proxyEvent","evtName","evt","vent","createMap","mapDiv","self","mapOpts","center","zoom","basemap","smartNavigation","navigationMode","fitExtent","minZoom","wrapAround180","esri","Map","onLoad","opts","disableScrollWheelZoom","coords","extent","geometry","Extent","SpatialReference","wkid","setExtent","hitch","getDatasetInfoTemplate","dataset","displayFieldName","get","title","InfoTemplate","getDatasetLayerOpts","mode","layers","FeatureLayer","MODE_AUTO","outFields","infoTemplate","geometryType","_addDefaultSymbols","addDataset","datasetLayer","layerDefinition","drawingInfo","setRenderer","_createRendererFromJson","renderer","onLoadDataset","addLayer","layer","minScale","maxScale","_applyRenderer","smap","graphics","length","attributes","field","redraw","refresh","type","smartMapping","createClassedColorRenderer","then","heatmap","createHeatmapRenderer","createClassedSizeRenderer","layerOptions","util","defaults","defaultPolygonRenderer","defaultPointRenderer","defaultLineRenderer","rendererJson","SimpleRenderer","ClassBreaksRenderer","xmin","ymin","xmax","ymax","spatialReference","serviceUrls","geometryService","label","description","symbol","color","size","angle","xoffset","yoffset","style","outline","width","Base","SearchView","ItemView","onRender","initTypeahead","highlight","minLength","hint","datasets","name","displayKey","item","templates","empty","source","ttAdapter","ui","typeahead","onTypeaheadSelected","model","set","page","updateModel","onKeyDown","e","which","preventDefault","onKeyUp","onSearchButtonClick","Model","per_page","total_count","sort_by","queryStringParams","getQueryString","pick","toJSON","param","getUrl","JST","datasets/templates/dataset","__t","__p","escape","moment","created_at","calendar","updated_at","tags","join","datasets/templates/table-row","Array","prototype","fields","datasets/templates/table","from","toLocaleString","to","total","sortField","alias","pages","error/templates/404","error/templates/500","home/templates/home","results/templates/results-empty","results/templates/results-item","fromNow","results/templates/results-loading","results/templates/results","collectionIsLoading","HeaderSearchView","listenTo","onQueryChanged","el","template","events","keydown #header-search","keyup #header-search","click #header-search-btn","typeahead:selected input","LayoutView","headerSearchView","render","regions","main","click #home-link","navigateHome","metaKey","ctrlKey","indexOf","$el","removeClass","addClass","HomeModule","View","keydown #search","keyup #search","click #search-btn","id","onDomRefresh","focus","Controller","initUi","view","getRegion","show","Router","AppRouter","appRoutes","addInitializer","controller","API","homeController","DatasetModel","arcgis_online_item_url","owner","views","thumbnail_url","parse","getNumericFields","contains","DatasetCollection","Collection","resp","metadata","query_parameters","stats","ResultsModule","tagName","click","onClick","LoadingView","className","EmptyView","CompositeView","selectDataset","childView","childViewContainer","getEmptyView","click ul.pagination a","modelEvents","change:total_count","collectionEvents","sync","error","onCollectionSync","childModel","onPageClicked","stopPropagation","target","closest","templateHelpers","active","info","len","Math","round","total_pages","ceil","end","clone","i","push","prevUrl","prevPage","nextUrl","nextPage","firstPage","lastPage","collection","fetch","cache","datasets(/)","queryObj","resultsController","DatasetRow","RowCollection","queryCapabilities","supportsPagination","supports_pagination","orderBy","perPage","orderByAsc","getQueryUrl","rows","features","first","DatasetsModule","TableRowView","TableView","click ul.pagination li a","click thead th","reset","childViewOptions","showPagination","sortClass","sortIconClass","totalPages","anchor","li","hasClass","sort","mapManager","tableContainer","change","baseUrl","tableView","toLowerCase","done","coordinates","initSmaps","numerics","fieldName","getStats","getGeometryType","yukiOptions","statistics","schemes","getSchemes","yuki","remove","Yuki","changeAttribute","changeRamp","_execStyleMap","fieldObj","findWhere","geomType","theme","styleType","styles","selectedScheme","index","secondarySchemes","scheme","request","buildPointLegend","breaks","onDestroy","onModelFetched","fail","datasets/:id(/)","datasetsController","ErrorModule","getTemplate","errorCode","404","500","initController","errorController","error404","error500"],"mappings":"AAEKA,KAAKC,MAA6B,gBAAdD,MAAKC,OAC5BD,KAAKC,SAGP,WACE,YAEAA,MAAO,GAAIC,UAASC,WAAWC,YAE/BH,KAAKI,GAAG,eAAgB,WACtBL,KAAKM,YAAc,GAAIL,MAAKM,OAAOC,YACnCR,KAAKS,OAAS,GAAIR,MAAKS,KAAKC,SAI9BV,KAAKI,GAAG,QAAS,WACfH,SAASU,QAAQP,GAAG,QAASL,KAAKS,OAAOI,YAErCX,SAASU,UAKNV,SAASU,QAAQE,OAAQC,WAAW,EAAOC,KAAM,wBACpDf,KAAKgB,SAAS,OAASC,SAAQ,OAKrCjB,KAAKgB,SAAW,SAAUE,EAAOC,GAC/BlB,SAASU,QAAQK,SAASE,EAAOC,IAGnCnB,KAAKoB,OAAS,WACZ,GAAIF,GAAQlB,KAAKK,YAAYgB,UAC7BrB,MAAKgB,SAASE,GAASD,SAAS,KAGlCjB,KAAKsB,gBAAkB,SAAUC,GAC/BvB,KAAKgB,SAAS,aAAeO,GAAaN,SAAS,KAGrDjB,KAAKwB,YAAc,WACjBxB,KAAKgB,SAAS,OAASC,SAAS,EAAMQ,SAAS,KAGjDzB,KAAK0B,oBAAsB,WACzB,GAAIC,MAEAC,EAAI3B,SAASU,QAAQkB,cAAcC,MAAM,KAAK,EAElD,IAAIF,EAAG,CACL,GAAIG,GAAQH,EAAEE,MAAM,IAEpBE,GAAEC,KAAKF,EAAO,SAASG,GACrBA,EAAOA,EAAKJ,MAAM,KAEhBH,EAAOO,EAAK,IADE,MAAZA,EAAK,GACWA,EAAK,GAAGT,QAAQ,MAAO,MAAQ,GAE/BU,mBAAmBD,EAAK,IAAM,MAKtD,MAAOP,IAKT3B,KAAKoC,cAAgB,WAkBnB,MAjBKrC,MAAKsC,aACRtC,KAAKsC,WAAa,GAAIC,aACpBC,eAAgBD,WAAWE,WAAWC,IAAIC,WAAW,SACrDC,eAAgBL,WAAWE,WAAWE,WACtCE,MAAO,GACPC,QACEC,IAAK9C,KAAK+C,OAAOC,IAAM,0CACvBC,cAAe,IACfxB,QAAS,SAAUqB,EAAKI,GACtB,MAAOJ,GAAIrB,QAAQ,SAAUyB,IAE/BC,OAAQ,SAASC,GACf,MAAOA,GAAWA,EAASC,aAK5BtD,KAAKsC,YAGdrC,KAAKsD,gBAAkB,WACrBrD,SAASU,QAAQ4C,WAKrB,WAEE,YAEAvD,MAAKwD,OAAO,QAAS,SAAUC,EAAOC,EAAKzD,EAAUC,EAAYyD,EAAG3B,GAElEyB,EAAMG,WAAa1D,EAAW2D,OAAOC,QAEnCC,WAAY,WACV/B,EAAEgC,QAAQjE,KAAM,eAEhBA,KAAKkE,cAAgBhE,EAASiE,MAAMC,MAAMC,QAAQ,UAElDrE,KAAKsE,YACLX,EAAIY,OAAOC,WAAW,qBAAsBxE,KAAKyE,cAOnDH,UAAW,WACT,GAAII,GAAMd,EAAEe,UACZ3E,MAAK4E,UAAYF,EAAIG,UAEhBC,OAAOC,KAWVL,EAAIM,UATJC,QAAQ,sCAAuC,WAE7CC,SAAS,WAAY,2BAA4B,uBAAwB,kBAAmB,WAC1FR,EAAIM,eAWZzB,gBAAiB,WACXvD,KAAKmF,KACPnF,KAAKmF,IAAIC,WAIbC,WAAY,SAAUC,EAASC,GAC7BvF,KAAKkE,cAAcsB,KAAKtE,QAAQoE,EAASC,IAK3CE,UAAW,SAAUC,EAAQtE,GAC3B,GAAIuE,GAAO3F,KACP4F,GACFC,QAAU,QAAS,QACnBC,KAAM,EACNC,QAAS,YACTC,iBAAgB,EAChBC,eAAgB,iBAChBC,WAAU,EACVC,QAAS,EACTC,eAAc,EAGhBpG,MAAKmF,IAAM,GAAIkB,MAAKC,IAAIZ,EAAQE,EAGhC,IAAIW,GAAS,SAASC,GAElB,GADAA,EAAKrB,IAAIsB,yBACLrF,EAAQsF,OAAQ,CAClB,GAAIC,GAAS,GAAIN,MAAKO,SAASC,OAAOzF,EAAQsF,OAAO,GAAG,GAAItF,EAAQsF,OAAO,GAAG,GAAItF,EAAQsF,OAAO,GAAG,GAAItF,EAAQsF,OAAO,GAAG,GAAI,GAAIL,MAAKS,kBAAmBC,KAAM,OAChKP,GAAKrB,IAAI6B,UAAUL,GAErBhB,EAAKN,WAAW,YAIpBrF,MAAKmF,IAAI9E,GAAG,OAAQ0E,KAAKkC,MAAMjH,KAAMuG,IACrCvG,KAAKmF,IAAI9E,GAAG,gBAAiB0E,KAAKkC,MAAMjH,KAAMA,KAAKqF,WAAY,sBAC/DrF,KAAKmF,IAAI9E,GAAG,YAAa0E,KAAKkC,MAAMjH,KAAMA,KAAKqF,WAAY,mBAM7D6B,uBAAwB,SAAUC,GAEhC,GAAIC,GAAmBD,EAAQE,IAAI,iBAC/BC,EAAQF,EAAmB,KAAOA,EAAmB,IAAM,YAC/D,OAAO,IAAIf,MAAKkB,aAAaD,EAAO,SAGtCE,oBAAqB,SAAUL,GAC7B,GAAIX,IAEFiB,KAAMpB,KAAKqB,OAAOC,aAAaC,UAC/BC,UAAW,IACXC,aAAc9H,KAAKkH,uBAAuBC,GAC1CY,aAAcZ,EAAQE,IAAI,iBAI5B,OADArH,MAAKgI,mBAAmBxB,GACjBA,GAGTyB,WAAY,SAAUd,GACpB,GAAIX,GAAOxG,KAAKwH,oBAAoBL,EACpCnH,MAAKkI,aAAe,GAAI7B,MAAKqB,OAAOC,aAAaR,EAAQE,IAAI,OAAQb,GAElEA,EAAK2B,iBAAmB3B,EAAK2B,gBAAgBC,aAE9CpI,KAAKkI,aAAaG,YAAYrI,KAAKsI,wBAAwB9B,EAAK2B,gBAAgBC,YAAYG,WAG9FvI,KAAKkI,aAAa7H,GAAG,OAAQL,KAAKwI,eAGlCxI,KAAKkI,aAAa7H,GAAG,OAAQ0E,KAAKkC,MAAMjH,KAAMA,KAAKqF,WAAY,0BAC/DrF,KAAKkI,aAAa7H,GAAG,QAAS0E,KAAKkC,MAAMjH,KAAMA,KAAKqF,WAAY,2BAChErF,KAAKkI,aAAa7H,GAAG,uBAAwB0E,KAAKkC,MAAMjH,KAAMA,KAAKqF,WAAY,0CAC/ErF,KAAKkI,aAAa7H,GAAG,aAAc0E,KAAKkC,MAAMjH,KAAMA,KAAKqF,WAAY,gCAErErF,KAAKmF,IAAIsD,SAASzI,KAAKkI,eAKzBM,cAAe,SAAUjD,GAEvBA,EAAImD,MAAMC,SAAW,EACrBpD,EAAImD,MAAME,SAAW,GAGvBnE,YAAa,SAAU+B,GACrB,GAAI9B,GAAMd,EAAEe,WAER+D,EAAQlC,EAAKkC,MAAQ1I,KAAKkI,aAE1BW,EAAiB,SAASC,GAC5BJ,EAAML,YAAYS,EAAKP,UAGlBG,EAAMK,UAAYL,EAAMK,SAASC,SAChCN,EAAMK,SAAS,GAAGE,WAAYzC,EAAK0C,OACrCR,EAAMS,SAENT,EAAMU,WAIV1E,EAAIM,QAAQ8D,EAAKP,UAqBnB,OAjBkB,YAAd/B,EAAK6C,KACPhD,KAAKkC,SAASe,aAAaC,2BAA2B/C,GACnDgD,KAAK,SAASjB,GACbM,EAAgBN,KAEG,UAAd/B,EAAK6C,MAAqB7C,EAAKiD,QAKjB,UAAdjD,EAAK6C,MAAoB7C,EAAKiD,SACvCpD,KAAKkC,SAASe,aAAaI,sBAAsBlD,GAC9CgD,KAAK,SAASjB,GACbM,EAAgBN,KAPpBlC,KAAKkC,SAASe,aAAaK,0BAA0BnD,GAClDgD,KAAK,SAASjB,GACbM,EAAgBN,KASf7D,EAAIG,WAUbmD,mBAAoB,SAAS4B,GAWzB,OATIA,EAAazB,kBACbyB,EAAazB,mBACbyB,EAAazB,gBAAgBC,gBAE7BwB,EAAazB,gBAAgBC,cAC7BwB,EAAazB,gBAAgBC,gBAIzBwB,EAAa7B,cACjB,IAAK,sBACD6B,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASC,sBAClE,MACJ,KAAK,oBACDH,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASE,oBAClE,MACJ,KAAK,yBACDJ,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASE,oBAClE,MACJ,KAAK,uBACDJ,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASG,mBAClE,MACJ,KAAK,mBACDL,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASG,mBAClE,MACJ,SACIL,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASC,uBAE1E,MAAOH,IAGXtB,wBAAyB,SAAS4B,GAC9B,GAAI3B,EACJ,QAAQ2B,EAAab,MACjB,IAAK,SAEDd,EAAW,GAAIlC,MAAKkC,SAAS4B,eAAeD,EAC5C,MACJ,KAAK,cACD3B,EAAW,GAAIlC,MAAKkC,SAAS6B,oBAAoBF,GAGzD,MAAO3B,WAQZvI,KAAK6J,MAA6B,gBAAd7J,MAAK6J,OAC1B7J,KAAK6J,SAGTA,KAAKC,UAEHnD,QACE0D,KAAQ,mBACRC,KAAQ,mBACRC,KAAQ,mBACRC,KAAQ,kBACRC,kBACE1D,KAAQ,SAIZ2D,aACEC,iBACE5H,IAAO,iFAOXiH,sBACEX,KAAQ,SACRuB,MAAS,GACTC,YAAe,GACfC,QACEC,OAAU,GAAG,IAAI,IAAI,KACrBC,KAAQ,EACRC,MAAS,EACTC,QAAW,EACXC,QAAW,EACX9B,KAAQ,UACR+B,MAAS,gBACTC,SACEN,OAAU,IAAI,IAAI,IAAI,KACtBO,MAAS,GACTjC,KAAQ,UACR+B,MAAS,kBASfnB,qBACEZ,KAAQ,SACRyB,QACEC,OAAU,EAAE,IAAI,IAAI,KACpBO,MAAS,EACTjC,KAAQ,UACR+B,MAAS,iBAQbrB,wBACEV,KAAQ,SACRyB,QACEC,OAAU,GAAG,IAAI,IAAI,KACrBM,SACEN,OAAU,IAAI,IAAI,IAAI,KACtBO,MAAS,GACTjC,KAAQ,UACR+B,MAAS,gBAEX/B,KAAQ,UACR+B,MAAS,kBAKf,WAEE,YAEAnL,MAAKwD,OAAO,OAAQ,SAAU8H,EAAM5H,EAAKzD,EAAUC,GAEjDoL,EAAKC,WAAarL,EAAWsL,SAAS1H,QAEpC2H,SAAU,WACR1L,KAAK2L,iBAGPA,cAAe,WACb,GAEInF,IACFoF,WAAW,EACXC,UAAW,EACXC,MAAM,GAKJxJ,EAAaqB,EAAItB,eACrBC,GAAW0B,YAEX,IAAI+H,IACFC,KAAM,WACNC,WAAY,SAASC,GACnB,MAAOA,IAETC,WACEC,MAAO,IAETC,OAAQ/J,EAAWgK,YAGrBtM,MAAKuM,GAAGlL,OAAOmL,UAAUhG,EAAMuF,IAGjCU,oBAAqB,WAEnBzM,KAAK0M,MAAMC,KACT9K,EAAG7B,KAAKuM,GAAGlL,OAAOmL,UAAU,OAC5BI,KAAM,IAGR5M,KAAKqB,UAGPwL,YAAa,WACX,GAAIhL,GAAI7B,KAAKuM,GAAGlL,OAAOmL,UAAU,MACjCxM,MAAK0M,MAAMC,KACT9K,EAAGA,EACH+K,KAAM,KAIVE,UAAU,SAASC,GACD,KAAZA,EAAEC,QACJD,EAAEE,iBAEFjN,KAAKuM,GAAGlL,OAAOmL,UAAU,SAEzBxM,KAAK6M,cAEL7M,KAAKqB,WAIT6L,QAAS,WACPlN,KAAK6M,eAGPM,oBAAqB,WACnBnN,KAAK6M,cACL7M,KAAKqB,UAGPA,OAAQ,WACNsC,EAAItC,iBAUZ,WAEE,YAEApB,MAAKwD,OAAO,SAAU,SAAUlD,EAAQoD,EAAKzD,EAAUC,EAAYyD,EAAG3B,GAKpE1B,EAAOC,YAAcN,EAASkN,MAAMrJ,QAElC+F,UACEjI,EAAG,GACH+K,KAAM,EACNS,SAAU,GACVC,YAAa,EACbC,QAAS,aAGXC,mBAAqB,IAAK,OAAQ,WAAY,WAE9CC,eAAgB,WAEd,GAAI/K,GAAMT,EAAEyL,KAAK1N,KAAK2N,SAAU3N,KAAKwN,kBAErC,OAAO5J,GAAEgK,MAAMlL,IAGjBpB,SAAU,SAAU2B,GAIlB,GAAI9B,GAAQ,UAGZ,OAFAA,IAAS,EAAQ,SAAW,IAC5BA,GAASnB,KAAKyN,kBAIhBI,OAAQ,WACN,MAAOlK,GAAIX,OAAOC,IAAMjD,KAAKsB,UAAS,WAS9CrB,KAAK+C,QAKHC,IAAK,4BAEPjD,KAAK8N,KAAOC,6BAA8B,SAASrL,KACnDA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,6FACuB,OAA5BD,IAAM,eAA6B,GAAKA,KAC1C,YACqB,OAAnBA,IAAM,MAAoB,GAAKA,KACjC,uUACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,4EACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,oEACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,2GACuC,OAArCA,IAAM,wBAAsC,GAAKA,KACnD,yEACoB,OAAlBA,IAAM,KAAmB,GAAKA,KAChC,2LAC4B,OAA1BA,IAAM,aAA2B,GAAKA,KACxC,oJACsB,OAApBA,IAAM,OAAqB,GAAKA,KAClC,oDAC8C,OAA5CA,IAAQG,OAAOC,YAAYC,YAAwB,GAAKL,KAC1D,4DAC8C,OAA5CA,IAAQG,OAAOG,YAAYD,YAAwB,GAAKL,KAC1D,iDACiC,OAA/BA,IAAQO,KAAKC,KAAK,QAAoB,GAAKR,KAC7C,0DACsB,OAApBA,IAAM,OAAqB,GAAKA,KAClC,8OAGA,OAAOC,MAEPQ,+BAAgC,SAAS/L,KACzCA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAAcQ,MAAMC,UAAUH,KAEzD,KAAM9L,IAELT,EAAEC,KAAK0M,OAAQ,SAAU1F,GAC1B+E,KAAO,YACgC,OAArCD,IAAQ/E,WAAWC,EAAM8C,OAAmB,GAAKgC,KACnD,YAEAC,KAAO,IAGP,OAAOA,MAEPY,2BAA4B,SAASnM,KACrCA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAAcQ,MAAMC,UAAUH,KAEzD,KAAM9L,IACNuL,KAAO,gBAC+B,OAApCD,IAAQc,KAAKC,kBAA8B,GAAKf,KAClD,QACoC,OAAlCA,IAAQgB,GAAGD,kBAA8B,GAAKf,KAChD,QACuC,OAArCA,IAAQiB,MAAMF,kBAA8B,GAAKf,KACnD,+IACC/L,EAAEC,KAAK0M,OAAQ,SAAU1F,GAC1B+E,KAAO,eAEPA,KADKiB,YAAchG,EAAM8C,KAClB,uCACoB,OAAzBgC,IAAQ9E,EAAW,MAAa,GAAK8E,KACvC,aAC0B,OAAxBA,IAAM,WAAyB,GAAKA,KACtC,sBAC0C,OAAxCA,IAAQ9E,EAAMiG,OAASjG,EAAM8C,MAAkB,GAAKgC,KACtD,iDAC8B,OAA5BA,IAAM,eAA6B,GAAKA,KAC1C,yEAEO,uCACoB,OAAzBA,IAAQ9E,EAAW,MAAa,GAAK8E,KACvC,sBAC0C,OAAxCA,IAAQ9E,EAAMiG,OAASjG,EAAM8C,MAAkB,GAAKgC,KACtD,kCAEAC,KAAO,eAEPA,KAAO,+GACFmB,MAAMpG,OAAS,IACpBiF,KAAO,sCACmB,OAAxBD,IAAM,WAAyB,GAAKA,KACtC,oBACyB,OAAvBA,IAAM,UAAwB,GAAKA,KACrC,qEACC/L,EAAEC,KAAKkN,MAAO,SAAUxC,GACzBqB,KAAO,yBACqB,OAA1BD,IAAQpB,EAAY,QAAa,GAAKoB,KACxC,wCAC0B,OAAxBA,IAAQpB,EAAU,MAAa,GAAKoB,KACtC,MAC0B,OAAxBA,IAAQpB,EAAU,MAAa,GAAKoB,KACtC,sBAEAC,KAAO,wCACkB,OAAvBD,IAAM,UAAwB,GAAKA,KACrC,oBACyB,OAAvBA,IAAM,UAAwB,GAAKA,KACrC,4DAEAC,KAAO,mBAGP,OAAOA,MAEPoB,sBAAuB,SAAS3M,KAChCA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,kHAGP,OAAOA,MAEPqB,sBAAuB,SAAS5M,KAChCA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,uFAGP,OAAOA,MAEPsB,sBAAuB,SAAS7M,KAChCA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,stBAGP,OAAOA,MAEPuB,kCAAmC,SAAS9M,KAC5CA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,8CAGP,OAAOA,MAEPwB,iCAAkC,SAAS/M,KAC3CA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,QACc,OAAnBD,IAAM,MAAoB,GAAKA,KACjC,eACsB,OAApBA,IAAM,OAAqB,GAAKA,KAClC,eAC6B,OAA3BA,IAAM,cAA4B,GAAKA,KACzC,eAC0B,OAAxBA,IAAM,WAAyB,GAAKA,KACtC,eACsB,OAApBA,IAAM,OAAqB,GAAKA,KAClC,eAC6C,OAA3CA,IAAQG,OAAOC,YAAYsB,WAAuB,GAAK1B,KACzD,eAC6C,OAA3CA,IAAQG,OAAOG,YAAYoB,WAAuB,GAAK1B,KACzD,OAGA,OAAOC,MAEP0B,oCAAqC,SAASjN,KAC9CA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,ySAGP,OAAOA,MAEP2B,4BAA6B,SAASlN,KACtCA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAAcQ,MAAMC,UAAUH,KAEzD,KAAM9L,IACNuL,KAAO,WACD4B,sBACN5B,KAAO,+BACW,OAAhBD,IAAM,GAAiB,GAAKA,KAC9B,mBAC6C,OAA3CA,IAAQV,YAAYyB,kBAA8B,GAAKf,KACzD,iBAEAC,KAAO,uaACFmB,MAAMpG,OAAS,IACpBiF,KAAO,sCACmB,OAAxBD,IAAM,WAAyB,GAAKA,KACtC,gBACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,iBACyB,OAAvBA,IAAM,UAAwB,GAAKA,KACrC,qEACC/L,EAAEC,KAAKkN,MAAO,SAAUxC,GACzBqB,KAAO,yBACqB,OAA1BD,IAAQpB,EAAY,QAAa,GAAKoB,KACxC,gBACyB,OAAvBA,IAAQpB,EAAS,KAAa,GAAKoB,KACrC,qCAC0B,OAAxBA,IAAQpB,EAAU,MAAa,GAAKoB,KACtC,MAC0B,OAAxBA,IAAQpB,EAAU,MAAa,GAAKoB,KACtC,sBAEAC,KAAO,wCACkB,OAAvBD,IAAM,UAAwB,GAAKA,KACrC,gBACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,iBACyB,OAAvBA,IAAM,UAAwB,GAAKA,KACrC,4DAEAC,KAAO,mBAGP,OAAOA,OAGP,WAEE,YAEAhO,MAAKwD,OAAO,OAAQ,SAAU/C,GAE5BA,EAAKoP,iBAAmB7P,KAAKsL,KAAKC,WAAWzH,QAE3CC,WAAY,WACVhE,KAAK+P,SAAS/P,KAAK0M,MAAO,WAAY1M,KAAKgQ,iBAG7CC,GAAI,2BAEJC,UAAU,EAEVC,QACEC,yBAA0B,YAC1BC,uBAAwB,UACxBC,2BAA4B,sBAC5BC,2BAA4B,uBAG9BhE,IACElL,OAAQ,kBAGV2O,eAAgB,WACdhQ,KAAKuM,GAAGlL,OAAOmL,UAAU,MAAOxM,KAAK0M,MAAMrF,IAAI,cAUvD,WAEE,YAEApH,MAAKwD,OAAO,OAAQ,SAAU/C,EAAMiD,EAAKzD,EAAUC,EAAYyD,EAAG3B,GAEhEvB,EAAKC,OAASR,EAAWqQ,WAAWzM,QAElCC,WAAY,WACV/B,EAAEgC,QAAQjE,KAAM,cAChBA,KAAKyQ,iBAAmB,GAAI/P,GAAKoP,kBAAmBpD,MAAO/I,EAAIrD,cAAeoQ,UAGhFT,GAAI,OAEJU,SACEC,KAAM,gBAGRT,QACEU,mBAAoB,gBAGtBC,aAAc,SAAU/D,GACjBA,EAAEgE,SAAYhE,EAAEiE,UACnBjE,EAAEE,iBACFtJ,EAAI1C,SAAS,IAAMC,SAAS,MAIhCL,WAAY,WACV,GAAI8E,GAAO3F,IACgD,KAAvDE,EAASU,QAAQkB,cAAcmP,QAAQ,YACzCtL,EAAKuL,IAAIC,YAAY,aAErBxL,EAAKuL,IAAIE,SAAS,qBAW5B,WAEE,YAEAnR,MAAKwD,OAAO,aAAc,SAAU4N,EAAY1N,GAE9C0N,EAAWC,KAAOrR,KAAKsL,KAAKC,WAAWzH,QAErCC,WAAY,WACVhE,KAAK0M,MAAQ/I,EAAIrD,aAGnB4P,SAAUpC,IAAI,uBAEdqC,QACEoB,kBAAmB,YACnBC,gBAAiB,UACjBC,oBAAqB,sBACrBlB,2BAA4B,uBAG9BhE,IACElL,OAAQ,WAGVqQ,GAAI,OAEJC,aAAc,WACZ3R,KAAKuM,GAAGlL,OAAOuQ,gBAUvB,WAEE,YAEA3R,MAAKwD,OAAO,aAAc,SAAU4N,EAAY1N,EAAKzD,EAAUC,GAE7DkR,EAAWQ,WAAa1R,EAAW0R,WAAW9N,QAE5C+N,OAAQ,WACN,GAAIC,GAAO,GAAIV,GAAWC,IAC1B3N,GAAIlD,OAAOuR,UAAU,QAAQC,KAAKF,WAU1C,WAEE,YAEA9R,MAAKwD,OAAO,aAAc,SAAU4N,EAAY1N,EAAKzD,GAGnDmR,EAAWa,OAAShS,EAASC,WAAWgS,UAAUpO,QAChDqO,WACE,GAAI,UAKRf,EAAWgB,eAAe,WACX,GAAIhB,GAAWa,QAASI,WAAYjB,EAAWkB,QAI9DlB,EAAWkB,KAETN,KAAM,SAAS7Q,GAETpB,KAAKwS,iBACPxS,KAAKwS,eAAiB,GAAInB,GAAWQ,WAAWzQ,IAGlDpB,KAAKwS,eAAeV,OAAO1Q,UAOnC,WAEE,YAEAnB,MAAKwD,OAAO,SAAU,SAAUlD,EAAQoD,EAAKzD,EAAUC,EAAYyD,EAAG3B,GAKpE1B,EAAOkS,aAAevS,EAASkN,MAAMrJ,QAEnC+F,UACE4H,GAAI,GACJ1F,KAAM,GACNnB,YAAa,GACb0D,QACAmE,uBAAwB,GACxBC,MAAO,GACP5P,IAAK,GACLqL,WAAY,GACZE,WAAY,GACZsE,MAAO,EACPC,cAAe,IAGjBC,MAAO,SAAUzP,GACf,MAAOA,GAASC,MAAQD,GAG1BN,IAAK,WACH,MAAO9C,MAAK+C,OAAOC,IAAM,YAAcjD,KAAKqH,IAAI,MAAQ,SAG1D0L,iBAAkB,WAChB,GAAInE,GAAS5O,KAAKqH,IAAI,SACtB,OAAOpF,GAAEmB,OAAOwL,EAAQ,SAAU1C,GAChC,MAAOjK,GAAE+Q,UAAW,sBAAuB,sBAAuB,wBAA0B9G,EAAK7C,gBAW3G,WAEE,YAEApJ,MAAKwD,OAAO,SAAU,SAAUlD,EAAQoD,EAAKzD,EAAUC,EAAYyD,EAAG3B,GAKpE1B,EAAO0S,kBAAoB/S,EAASgT,WAAWnP,QAE7C2I,MAAOnM,EAAOkS,aAEd1P,IAAK,WACH,MAAOY,GAAIrD,YAAYuN,QAAO,IAGhCiF,MAAO,SAAUK,GAGf,MADAxP,GAAIrD,YAAYqM,IAAI1K,EAAE8B,OAAOoP,EAAKC,SAASC,iBAAkBF,EAAKC,SAASE,QACpEH,EAAK7P,aAUpB,WAEE,YAEArD,MAAKwD,OAAO,gBAAiB,SAAU8P,EAAe5P,EAAKzD,EAAUC,EAAYyD,GAE/E2P,EAAc9H,SAAWtL,EAAWsL,SAAS1H,QAE3CmM,SAAUpC,IAAI,kCAEdpB,MAAOzM,KAAKM,OAAOkS,aAEnBe,QAAS,KAETrD,QACEsD,MAAO,WAGTC,QAAS,WACP1T,KAAKkB,QAAQ,iBAAkBlB,KAAK0M,UAKxC6G,EAAcI,YAAcxT,EAAWsL,SAAS1H,QAE9CmM,SAAUpC,IAAI,qCAEd0F,QAAS,KAETI,UAAW,YAIbL,EAAcM,UAAY1T,EAAWsL,SAAS1H,QAE5CmM,SAAUpC,IAAI,mCAEd0F,QAAS,OAIXD,EAAcjC,KAAOnR,EAAW2T,cAAc/P,QAE5CC,WAAY,WACVhE,KAAK+P,SAAS/P,KAAM,2BAA4BA,KAAK+T,gBAGvDlE,qBAAqB,EAErBK,SAAUpC,IAAI,6BAEdkG,UAAWT,EAAc9H,SAEzBwI,mBAAoB,QAEpBC,aAAc,WACZ,MAAIlU,MAAK6P,oBACA0D,EAAcI,YAEdJ,EAAcM,WAIzB1D,QACEgE,wBAAyB,iBAG3BC,aACEC,qBAAsB,UAGxBC,kBACEC,KAAQ,mBACRC,MAAS,oBAGX9C,GAAI,eAEJ+C,iBAAkB,WAChBzU,KAAK6P,qBAAsB,EAC3B7P,KAAK0Q,UAGPqD,cAAe,SAAUC,EAAWU,GAClC/Q,EAAIpC,gBAAgBmT,EAAWrN,IAAI,QAGrCsN,cAAe,SAAU5H,GAEvB,IAAKA,EAAEgE,UAAWhE,EAAEiE,QAAS,CAC3BjE,EAAE6H,kBACF7H,EAAEE,gBACF,IAAIL,GAAOhJ,EAAEmJ,EAAE8H,QAAQC,QAAQ,KAAKxR,KAAK,OAIzCtD,MAAK0M,MAAMC,IAAI,OAAQC,GACvBjJ,EAAItC,WAIR0T,gBAAiB,WAkBf,IAAK,GADDC,GAfAC,EAAOtR,EAAIrD,YAAYqN,SAEvBuH,EAAMC,KAAKC,MAAMH,EAAK3H,aACtBV,GAAQqI,EAAKrI,KACbkC,EAAiB,IAATlC,EAAcA,EAAO,EAAIA,EACjC5B,EAAOiK,EAAK5H,SACZgI,EAAcF,KAAKG,KAAKJ,EAAMlK,GAC9BoE,KAGAtO,EAAUuU,EAAc,IAAMvG,EAAO,EAAMA,EAAO,EAAI,EACtDyG,EAAQF,EAAcvU,EAAQ,EAAMA,EAAQ,EAAIuU,EAGhD/U,EAAcN,KAAK0M,MAAM8I,QAEpBC,EAAI3U,EAAYyU,GAALE,EAAUA,IAC5BT,EAAUS,IAAM3G,EAAQ,SAAW,GACnCxO,EAAYqM,IAAI,OAAQ8I,GACxBrG,EAAMsG,MAAO3S,IAAKzC,EAAYgB,UAAS,GAAQsL,KAAM6I,EAAGT,OAAQA,GAGlE,IAAIW,GAAU3V,KAAK0M,MAAMpL,UAAS,GAC9BsU,EAAWhJ,CACF,KAATkC,IACF8G,EAAWhJ,EAAK,EAChBtM,EAAYqM,IAAI,OAAQiJ,GACxBD,EAAUrV,EAAYuN,SAExB,IAAIgI,GAAU7V,KAAK0M,MAAMpL,UAAS,GAC9BwU,EAAWlJ,CAOf,OANIyI,KAAgBvG,IAClBgH,EAAWlJ,EAAO,EAClBtM,EAAYqM,IAAI,OAAQmJ,GACxBD,EAAUvV,EAAYuN,WAItBkI,UAAqB,IAATjH,EAAc,WAAa,GACvCkH,SAAWX,IAAgBvG,EAAQ,WAAa,GAChD6G,QAASA,EACTE,QAASA,EACTD,SAAUA,EACVE,SAAUA,EACV1G,MAAOA,EACPS,oBAAqB7P,KAAK6P,6BAWpC,WAEE,YAEA5P,MAAKwD,OAAO,gBAAiB,SAAU8P,EAAe5P,EAAKzD,EAAUC,GAEnEoT,EAAc1B,WAAa1R,EAAW0R,WAAW9N,QAE/C+N,OAAQ,WACN9R,KAAKiW,WAAa,GAAItS,GAAIpD,OAAO0S,kBACjCjT,KAAKiW,WAAWC,OAAQC,OAAO,IAC/BnW,KAAK+R,KAAO,GAAIwB,GAAcjC,MAAO5E,MAAO/I,EAAIrD,YAAa2V,WAAYjW,KAAKiW,aAC9EtS,EAAIlD,OAAOuR,UAAU,QAAQC,KAAKjS,KAAK+R,cAU/C,WAEE,YAEA9R,MAAKwD,OAAO,gBAAiB,SAAU8P,EAAe5P,EAAKzD,GAGzDqT,EAAcrB,OAAShS,EAASC,WAAWgS,UAAUpO,QACnDqO,WACEgE,cAAe,UAKnB7C,EAAclB,eAAe,WACd,GAAIkB,GAAcrB,QAASI,WAAYiB,EAAchB,QAIpEgB,EAAchB,KAEZN,KAAM,SAAS7Q,GAEb,GAAIiV,GAAW1S,EAAIhC,qBAInBgC,GAAIrD,YAAYqM,IAAI0J,GAEhBrW,KAAKsW,oBACPtW,KAAKsW,kBAAoB,GAAI/C,GAAc1B,WAAWzQ,IAGxDpB,KAAKsW,kBAAkBxE,OAAO1Q,UAQtC,WAEE,YAEAnB,MAAKwD,OAAO,SAAU,SAAUlD,EAAQoD,EAAKzD,GAK3CK,EAAOgW,WAAarW,EAASkN,MAAMrJ,gBASvC,WAEE,YAEA9D,MAAKwD,OAAO,SAAU,SAAUlD,EAAQoD,EAAKzD,EAAUC,EAAYyD,EAAG3B,GAKpE1B,EAAOiW,cAAgBtW,EAASgT,WAAWnP,QAEzCC,WAAY,SAAUiF,EAAY7H,GAChCpB,KAAKmH,QAAU/F,EAAQ+F,OAEvB,IAAIsP,GAAoBzW,KAAKmH,QAAQE,IAAI,8BACzCrH,MAAK0W,mBAAqBD,GAAqBA,EAAkBE,oBAEjE3W,KAAK4W,QAAU5W,KAAKmH,QAAQE,IAAI,oBAGlCwP,QAAS,GAETjK,KAAM,EAENgK,QAAS,GAETE,YAAY,EAEZpK,MAAOnM,EAAOgW,WAEdQ,YAAa,WACX,GAAIhU,GAAM/C,KAAKmH,QAAQE,IAAI,MAC3BtE,IAAO,gYAEH/C,KAAK0W,qBACP3T,GAAO,iBAAmB/C,KAAK4M,KAAO5M,KAAK6W,QAC3C9T,GAAO,sBAAwB/C,KAAK6W,QAOtC,IAAID,GAAU5W,KAAK4W,OASnB,OARK5W,MAAK8W,aACRF,GAAW,SAKb7T,GAAO,kBAAoB6T,GAK7B7T,IAAK,WACH,MAAO/C,MAAK+W,eAGdjE,MAAO,SAAUK,GAGf,GAAI6D,GAAO7D,EAAK8D,QAQhB,OAPKjX,MAAK0W,qBAKRM,EAAO/U,EAAEiV,MAAMF,EAAMhX,KAAK6W,UAErBG,UAUf,WAEE,YAEA/W,MAAKwD,OAAO,iBAAkB,SAAU0T,EAAgBxT,EAAKzD,EAAUC,EAAYyD,GAEjFuT,EAAeC,aAAejX,EAAWsL,SAAS1H,QAEhDC,WAAY,SAAU5C,GACpBpB,KAAKmH,QAAU/F,EAAQ+F,QACvBnH,KAAK4O,OAAS5O,KAAKmH,QAAQE,IAAI,WAGjC6I,SAAUpC,IAAI,gCAEdiH,gBAAiB,WACf,GAAIpP,GAAO3F,IACX,QACE4O,OAAQjJ,EAAKiJ,SAIjBlC,MAAOzM,KAAKM,OAAOgW,WAEnB/C,QAAS,OAIX2D,EAAeE,UAAYlX,EAAW2T,cAAc/P,QAElDC,WAAY,WACVhE,KAAKiW,WAAa,GAAItS,GAAIpD,OAAOiW,kBAAoBrP,QAASnH,KAAK0M,QACnE1M,KAAKiW,WAAWC,SAGlB/F,QACEmH,2BAA4B,gBAC5BC,iBAAkB,QAGpBjD,kBAEEkD,MAAS,UAGXtH,SAAUpC,IAAI,4BAEdkG,UAAWmD,EAAeC,aAE1BK,iBAAkB,WAChB,GAAItQ,GAAUnH,KAAK0M,KACnB,QACEvF,QAASA,IAIb4N,gBAAiB,WAGf,GAAIrS,IACFqT,UAAW,GACXC,SAAU,GACVJ,SAAU,EACVE,SAAU,EACV1G,SACAsI,gBAAgB,EAChB5I,KAAM,EACNE,GAAIhP,KAAKiW,WAAWY,QACpB5H,MAAOjP,KAAK0M,MAAMrF,IAAI,gBACtB6H,UAAWlP,KAAKiW,WAAWW,QAC3Be,UAAW3X,KAAKiW,WAAWa,WAAa,WAAa,YACrDc,cAAe5X,KAAKiW,WAAWa,WAAa,yBAA2B,uBAGzE,IAAI9W,KAAKiW,WAAWS,mBAAoB,CAUtC,IAAK,GADD1B,GARA6C,EAAa1C,KAAKG,KAAKtV,KAAK0M,MAAMrF,IAAI,gBAAkBrH,KAAKiW,WAAWY,SAExEjK,EAAO5M,KAAKiW,WAAWrJ,KAGvB9L,EAAS+W,EAAa,IAAMjL,EAAO,EAAKA,EAAO,EAAI,EACnD2I,EAAOsC,EAAa/W,EAAQ,EAAKA,EAAQ,EAAI+W,EAErCzI,KACHqG,EAAI3U,EAAYyU,GAALE,EAAUA,IAC5BT,EAAUS,IAAM7I,EAAO,EAAK,SAAW,GACvCwC,EAAMsG,MAAO9I,KAAM6I,EAAGT,OAAQA,GAGhC,IAAI/F,GAAQjP,KAAK0M,MAAMrF,IAAI,gBACvByH,EAAOlC,EAAO5M,KAAKiW,WAAWY,QAAU,EACxC7H,EAAKpC,EAAO5M,KAAKiW,WAAWY,QAAU7W,KAAKiW,WAAWY,OAC1D7H,GAAYC,GAAND,EAAeA,EAAKC,EAE1BvM,GACEqT,UAAqB,IAATnJ,EAAc,WAAa,GACvCoJ,SAAW6B,IAAejL,EAAO,EAAK,WAAa,GACnDgJ,SAAUhJ,EACVkJ,SAAUlJ,EAAO,EACjBwC,MAAOA,EACPsI,gBAAgB,EAChB5I,KAAMA,EACNE,GAAIA,EACJC,MAAOA,EACPC,UAAWlP,KAAKiW,WAAWW,QAC3Be,UAAW3X,KAAKiW,WAAWa,WAAa,WAAa,YACrDc,cAAe5X,KAAKiW,WAAWa,WAAa,yBAA2B,wBAI3E,MAAOpU,IAGTuR,mBAAoB,QAEpBU,cAAe,SAAU5H,GACvB,GAAI+K,GAASlU,EAAEmJ,EAAE8H,QAAQC,QAAQ,KAC7BiD,EAAKD,EAAOhD,QAAQ,KACxB,KAAKiD,EAAGC,SAAS,cAAgBD,EAAGC,SAAS,UAAW,CACtD,GAAIpL,GAAOkL,EAAOxU,KAAK,QAAU,CACjCtD,MAAKiW,WAAWrJ,KAAOA,EACvB5M,KAAKiW,WAAWC,OAAQsB,OAAO,MAInCS,KAAM,SAAUlL,GACd,GAAI6J,GAAUhT,EAAEmJ,EAAE8H,QAAQvR,KAAK,YAC3BsT,KAEA5W,KAAKiW,WAAWa,WADdF,IAAY5W,KAAKiW,WAAWW,SACA5W,KAAKiW,WAAWa,YAEjB,EAE/B9W,KAAKiW,WAAWrJ,KAAO,EACvB5M,KAAKiW,WAAWW,QAAUA,EAC1B5W,KAAKiW,WAAWC,OAAQsB,OAAO,aAWzC,WAEE,YAEAvX,MAAKwD,OAAO,iBAAkB,SAAU0T,EAAgBxT,EAAKzD,EAAUC,EAAYyD,EAAG3B,GAEpFkV,EAAe7F,KAAOnR,EAAWsL,SAAS1H,QAExCC,WAAY,SAAU5C,GACpBa,EAAEgC,QAAQjE,KAAM,kBAAmB,cACnCA,KAAKkY,WAAa9W,EAAQ8W,YAG5BhI,SAAUpC,IAAI,8BAEd4D,GAAI,eAEJnF,IACE7G,OAAU,OACVyS,eAAkB,oBAGpB/D,aACEgE,OAAU,UAGZrD,gBAAiB,WACf,GAAIsD,GAAUrY,KAAK0M,MAAM3J,MAAMrB,QAAQ,SAAU,GACjD,QACE2W,QAASA,IAIb3M,SAAU,WAER1L,KAAKsY,UAAY,GAAInB,GAAeE,WAAYpH,GAAIjQ,KAAKuM,GAAG4L,eAAgBzL,MAAO1M,KAAK0M,QAASgE,UAOnGiB,aAAc,WACZ,GAAkD,UAA9C3R,KAAK0M,MAAMrF,IAAI,aAAakR,cAA2B,CACzD,GAAI5S,GAAO3F,IAEXA,MAAKuM,GAAG7G,OAAOuM,OACfjS,KAAKkY,WAAWtT,UAAU4T,KAAK,WAC7B7S,EAAKuS,WAAWzS,UAAU,OAASiB,OAAQf,EAAK+G,MAAMrF,IAAI,UAAUoR,cACpE9S,EAAKuS,WAAWjQ,WAAWtC,EAAK+G,WAOtCgM,UAAW,WACT,GAAIC,GAAW3Y,KAAK0M,MAAMqG,kBAE1B,IAAI4F,EAAS3P,OAAO,CAIlBhJ,KAAK4Y,UAAY5Y,KAAK4Y,WAAaD,EAAS,GAAG3M,IAG/C,IAAI4C,GAAS5O,KAAK0M,MAAMrF,IAAI,SAC5BrH,MAAKsT,MAAQtT,KAAK6Y,SAASjK,EAAQ5O,KAAK4Y,WACxC5Y,KAAKqJ,KAAOrJ,KAAK8Y,gBAAgB9Y,KAAK0M,MAAMrF,IAAI,iBAGhD,IAAI0R,IACFnK,OAAQ+J,EACRzP,MAAOlJ,KAAK4Y,UACZI,WAAYhZ,KAAKsT,MACjBjK,KAAMrJ,KAAKqJ,KACX4P,QAASjZ,KAAKkZ,aAGXlZ,MAAKmZ,MAGRvV,EAAE,mBAAmBwV,SACrBpZ,KAAKmZ,KAAO,GAAIE,MAAK,QAASN,IAH9B/Y,KAAKmZ,KAAO,GAAIE,MAAK,QAASN,GAOhC/Y,KAAKmZ,KAAK9Y,GAAG,SAAUL,KAAKsZ,iBAC5BtZ,KAAKmZ,KAAK9Y,GAAG,cAAeL,KAAKuZ,YAEjCvZ,KAAKwZ,kBAKTX,SAAU,SAAUjK,EAAQgK,GAC1B,GAAIa,GAAWxX,EAAEyX,UAAU9K,GAAU5C,KAAM4M,GAC3C,OAAOa,GAAWA,EAAST,WAAa,MAG1CF,gBAAiB,SAAUa,GACzB,OAAQA,GACN,IAAK,oBACL,IAAK,yBACH,MAAO,OACT,KAAK,uBACH,MAAO,MACT,KAAK,sBACH,MAAO,SACT,SACE,MAAOA,GAASpB,gBAItBW,WAAY,WACV,GAAIU,GAAOC,EAAWlU,EAAO3F,IAC7B,QAAQA,KAAKqJ,MACX,IAAK,QACHuQ,EAAQ,UACRC,EAAY,MACZ,MACF,KAAK,UACHD,EAAQ,cACRC,EAAY,aAKhB,MAAOxT,MAAKyT,OAAOD,GAAWX,YAC5BU,MAAOA,EACP7T,QAAS,YACTgC,aAAcpC,EAAK0D,QAKvBiQ,gBAAiB,SAAUV,GAEzB,GAAIhK,GAAS5O,KAAK0M,MAAMrF,IAAI,SAC5BrH,MAAKsT,MAAQtT,KAAK6Y,SAASjK,EAAQgK,GACnC5Y,KAAK4Y,UAAYA,EAEjB5Y,KAAKwZ,cAAcxZ,KAAK+Z,iBAI1BR,WAAY,SAAUS,GACpBha,KAAK+Z,eAAiB/Z,KAAKkZ,aAAae,iBAAiBD,GACzDha,KAAKwZ,cAAcxZ,KAAK+Z,iBAI1BP,cAAe,SAAUU,GACvB,GAAIvU,GAAO3F,KAEPwG,GACF0C,MAAOlJ,KAAK4Y,UACZ7S,QAAS,YACTiT,WAAYhZ,KAAKsT,MACjBjK,KAAMrJ,KAAKqJ,KAGT6Q,KACF1T,EAAK0T,OAASA,EAGNvW,GAAIY,OAAO4V,QAAQ,qBAAsB3T,GAChDgS,KAAK,SAASjQ,GACK,UAAd5C,EAAK0D,MACP1D,EAAKwT,KAAKiB,iBAAiB7R,EAAS8R,WAK5CC,UAAW,WACTta,KAAKkY,WAAW9S,UAChBpF,KAAKsY,UAAUlT,kBAUvB,WAEE,YAEAnF,MAAKwD,OAAO,iBAAkB,SAAU0T,EAAgBxT,EAAKzD,EAAUC,EAAYyD,EAAG3B,GAEpFkV,EAAetF,WAAa1R,EAAW0R,WAAW9N,QAEhDC,WAAY,WACV/B,EAAEgC,QAAQjE,KAAM,mBAGlB8R,OAAQ,SAAU1Q,GAChBpB,KAAKkY,WAAa,GAAIvU,GAAID,MAAMG,WAChC7D,KAAK0M,MAAQ,GAAI/I,GAAIpD,OAAOkS,cAAef,GAAItQ,IAC/CpB,KAAK0M,MACFwJ,QACEsC,KAAKxY,KAAKua,gBACVC,KAAK,WACJ7W,EAAIlC,iBAIZ8Y,eAAgB,WACd,GAAIxI,GAAO,GAAIoF,GAAe7F,MAAO5E,MAAO1M,KAAK0M,MAAOwL,WAAYlY,KAAKkY,YACzEvU,GAAIlD,OAAOuR,UAAU,QAAQC,KAAKF,IAGpCxO,gBAAiB,WACXvD,KAAKkY,YACPlY,KAAKkY,WAAW9S,kBAW1B,WAEE,YAEAnF,MAAKwD,OAAO,iBAAkB,SAAU0T,EAAgBxT,EAAKzD,GAG3DiX,EAAejF,OAAShS,EAASC,WAAWgS,UAAUpO,QACpDqO,WACEqI,kBAAmB,UAKvBtD,EAAe9E,eAAe,WACf,GAAI8E,GAAejF,QAASI,WAAY6E,EAAe5E,QAItE4E,EAAe5E,KAEbN,KAAM,SAAS7Q,GAETpB,KAAK0a,qBACP1a,KAAK0a,mBAAqB,GAAIvD,GAAetF,WAAWzQ,IAG1DpB,KAAK0a,mBAAmB5I,OAAO1Q,UAOvC,WAEE,YAEAnB,MAAKwD,OAAO,cAAe,SAAUkX,EAAahX,EAAKzD,EAAUC,GAE/Dwa,EAAYrJ,KAAOnR,EAAWsL,SAAS1H,QAErC2N,GAAI,aAEJkJ,YAAa,WACX,GACI1K,GADA2K,EAAY7a,KAAK0M,MAAMrF,IAAI,YAG/B,QAAQwT,GACN,IAAK,KACH3K,EAAWpC,IAAI,sBACf,MACF,SACEoC,EAAWpC,IAAI,uBAGnB,MAAOoC,WAUf,WAEE,YAEAjQ,MAAKwD,OAAO,cAAe,SAAUkX,EAAahX,EAAKzD,EAAUC,GAE/Dwa,EAAY9I,WAAa1R,EAAW0R,WAAW9N,QAE7C+N,OAAQ,SAAU1Q,GAEhB,GAAIsL,GAAQ,GAAIxM,GAASkN,OAAQyN,UAAWzZ,EAAQyZ,YAChD9I,EAAO,GAAI4I,GAAYrJ,MAAO5E,MAAOA,GAEzC/I,GAAIlD,OAAOuR,UAAU,QAAQC,KAAKF,WAU1C,WAEE,YAEA9R,MAAKwD,OAAO,cAAe,SAAUkX,EAAahX,EAAKzD,GAGrDya,EAAYzI,OAAShS,EAASC,WAAWgS,UAAUpO,QACjDqO,WACE0I,IAAO,WACPC,IAAO,cAKXJ,EAAYtI,eAAe,WACZ,GAAIsI,GAAYzI,QAASI,WAAYqI,EAAYpI,QAIhEoI,EAAYpI,KAEVyI,eAAgB,WACVhb,KAAKib,kBACPjb,KAAKib,gBAAkB,GAAIN,GAAY9I,aAI3CqJ,SAAU,WACRlb,KAAKgb,iBACLhb,KAAKib,gBAAgBnJ,QAAS+I,UAAW,OAG3CM,SAAU,WACRnb,KAAKgb,iBACLhb,KAAKib,gBAAgBnJ,QAAS+I,UAAW,aAOjDjX,EAAE,WACA,YAEA3D,MAAKa","file":"scripts/main.js","sourcesContent":["/*jshint -W020 */\n\nif (!this.MyOD || typeof this.MyOD !== 'object') {\n  this.MyOD = {};\n}\n\n(function () {\n  'use strict';\n\n  MyOD = new Backbone.Marionette.Application();\n\n  MyOD.on('before:start', function(options){\n    this.searchModel = new MyOD.Models.SearchModel();\n    this.layout = new MyOD.Main.Layout();\n    //this.reqres = new Backbone.Wreqr.RequestResponse();\n  });\n\n  MyOD.on('start', function(options){\n    Backbone.history.on('route', this.layout.setClasses);\n\n    if (Backbone.history){\n      //if you are hosting on a server that can let the browser handle all the routing,\n      //you can use pushstate, otherwise (gh-pages) use hashed urls\n      //Backbone.history.start({ pushState: Modernizr.history, root: '/OpenData-Backbone' });\n      //Backbone.history.start returns false if the current url doesn't match a route\n      if (!Backbone.history.start({ pushState: false, root: '/OpenData-Backbone' })) {\n        MyOD.navigate('404', { trigger:true });\n      }\n    }\n  });\n\n  MyOD.navigate = function (route, options) {\n    Backbone.history.navigate(route, options);\n  };\n\n  MyOD.search = function (options) {\n    var route = MyOD.searchModel.getRoute();\n    MyOD.navigate(route, { trigger: true });\n  };\n\n  MyOD.navigateDataset = function (datasetId) {\n    MyOD.navigate('/datasets/' + datasetId, { trigger: true });\n  };  \n\n  MyOD.navigate404 = function () {\n    MyOD.navigate('404', { trigger: true, replace: true });\n  };\n\n  MyOD.queryStringToObject = function () {\n    var result = {};\n\n    var q = Backbone.history.getFragment().split('?')[1];\n\n    if (q) {\n      var pairs = q.split('&');\n      \n      _.each(pairs, function(pair) {\n        pair = pair.split('=');\n        if (pair[0] === 'q') {\n          result[pair[0]] = pair[1].replace(/\\+/g, ' ') || '';\n        } else {\n          result[pair[0]] = decodeURIComponent(pair[1] || '');\n        }\n      });\n    }\n\n    return result;\n  };\n\n  //by putting it on app instead of this base view, we can share one instance throughout the app\n  //instead of having one instance per view that needs one\n  MyOD.getBloodhound = function () {\n    if (!this.bloodhound) {\n      this.bloodhound = new Bloodhound({\n        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),\n        queryTokenizer: Bloodhound.tokenizers.whitespace,\n        limit: 10,\n        remote: {\n          url: MyOD.config.api + 'datasets/autocomplete.json?query=%QUERY',\n          rateLimitWait: 150,\n          replace: function (url, query) {\n            return url.replace('%QUERY', query);\n          },\n          filter: function(response) {\n            return response ? response.data : [];\n          }\n        }\n      });\n    }\n    return this.bloodhound;\n  };\n\n  MyOD.onBeforeDestroy = function () {\n    Backbone.history.stop();\n  };\n\n})();\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('Utils', function (Utils, App, Backbone, Marionette, $, _) {\n\n    Utils.MapManager = Marionette.Object.extend({\n      \n      initialize: function () {\n        _.bindAll(this, 'updateStyle');\n\n        this.globalChannel = Backbone.Wreqr.radio.channel('global');\n        //load dojo and start the map\n        this._loadDojo();\n        App.reqres.setHandler('smaps:update:style', this.updateStyle);\n\n      },\n\n      /**\n       * load dojo, resolve a promise when it's ready to roll\n       */\n      _loadDojo: function(){\n        var dfd = $.Deferred();\n        this.dojoReady = dfd.promise();\n        //check if dojo is loaded...\n        if( !window.dojo ){\n          //if not, inject a script tag, and then require in things\n          include('//js.arcgis.com/3.13compact/init.js', function(){\n            //now that require is present, load in the other things we need\n            require(['esri/map', 'esri/layers/FeatureLayer', 'plugins/smartMapping', 'dojo/domReady!'], function(Map) {\n              dfd.resolve();\n            });\n          }); \n\n        }else{\n          //it's loaded\n          dfd.resolve();\n        }\n      },\n\n\n      onBeforeDestroy: function () {\n        if (this.map) {\n          this.map.destroy();\n        }\n      },\n\n      proxyEvent: function (evtName, evt) {\n        this.globalChannel.vent.trigger(evtName, evt);\n        //OR (if everything that will listen has a reference to this)\n        //this.trigger(evtName, evt);\n      },\n\n      createMap: function (mapDiv, options) {\n        var self = this;\n        var mapOpts = {\n          center: [ -56.049, 38.485 ],\n          zoom: 3,\n          basemap: 'dark-gray',\n          smartNavigation:false,\n          navigationMode: 'css-transforms',\n          fitExtent:true,\n          minZoom: 2,\n          wrapAround180:true\n        };\n\n        this.map = new esri.Map(mapDiv, mapOpts);\n        \n       \n        var onLoad = function(opts){\n            opts.map.disableScrollWheelZoom();\n            if (options.coords) {\n              var extent = new esri.geometry.Extent(options.coords[0][0], options.coords[0][1], options.coords[1][0], options.coords[1][1], new esri.SpatialReference({ wkid: 4326 }));\n              opts.map.setExtent(extent);\n            }\n            self.proxyEvent('map:load');\n        };\n\n        //proxy events\n        this.map.on('load', dojo.hitch(this, onLoad));\n        this.map.on('extent-change', dojo.hitch(this, this.proxyEvent, 'map:extent-change'));\n        this.map.on('layer-add', dojo.hitch(this, this.proxyEvent, 'map:layer-add'));\n      },\n\n\n\n\n      getDatasetInfoTemplate: function (dataset) {\n        //var datasetName = dataset.get('name');\n        var displayFieldName = dataset.get('display_field');\n        var title = displayFieldName ? '${' + displayFieldName + '}' : 'Attributes';\n        return new esri.InfoTemplate(title, '${*}');\n      },\n\n      getDatasetLayerOpts: function (dataset) {\n        var opts = \n         { \n          mode: esri.layers.FeatureLayer.MODE_AUTO,\n          outFields: '*',\n          infoTemplate: this.getDatasetInfoTemplate(dataset),\n          geometryType: dataset.get('geometry_type')\n        };\n        //add the default symbol\n        this._addDefaultSymbols(opts);\n        return opts;\n      },\n\n      addDataset: function (dataset) {\n        var opts = this.getDatasetLayerOpts(dataset);\n        this.datasetLayer = new esri.layers.FeatureLayer(dataset.get('url'), opts);\n        //apply default renderer\n        if(opts.layerDefinition && opts.layerDefinition.drawingInfo){\n          //apply renderers\n          this.datasetLayer.setRenderer(this._createRendererFromJson(opts.layerDefinition.drawingInfo.renderer));\n        }\n\n        this.datasetLayer.on('load', this.onLoadDataset);\n\n        //proxy events\n        this.datasetLayer.on('load', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:load'));\n        this.datasetLayer.on('click', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:click'));\n        this.datasetLayer.on('query-limit-exceeded', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:query-limit-exceeded'));\n        this.datasetLayer.on('update-end', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:update-end'));\n\n        this.map.addLayer(this.datasetLayer);\n\n\n      },\n\n      onLoadDataset: function (evt) {\n        //squash scale ranges - we need the layer to draw at all scales\n        evt.layer.minScale = 0; \n        evt.layer.maxScale = 0;\n      },\n\n      updateStyle: function (opts) {\n        var dfd = $.Deferred();\n\n        var layer = opts.layer = this.datasetLayer;\n\n        var _applyRenderer = function(smap){\n          layer.setRenderer(smap.renderer);\n\n          //check if refresh needed, else redraw\n          if ( layer.graphics && layer.graphics.length ) {\n            if (layer.graphics[0].attributes[ opts.field ]) {\n              layer.redraw();\n            } else {\n              layer.refresh();\n            }\n          }\n\n          dfd.resolve(smap.renderer);\n        };\n\n          \n        if (opts.type === 'polygon'){\n          esri.renderer.smartMapping.createClassedColorRenderer(opts)\n            .then(function(renderer){\n              _applyRenderer( renderer );\n            });\n        } else if (opts.type === 'point' && !opts.heatmap){\n          esri.renderer.smartMapping.createClassedSizeRenderer(opts)\n            .then(function(renderer){\n              _applyRenderer( renderer );\n            });\n        } else if (opts.type === 'point' && opts.heatmap) {\n          esri.renderer.smartMapping.createHeatmapRenderer(opts)\n            .then(function(renderer){\n              _applyRenderer( renderer );\n            });\n        }\n\n        return dfd.promise();\n      },\n\n      /**\n       * Append in default layer styling by adding/updateing \n       * layerOptions.layerDefinition.drawingInfo and setting it's properties\n       * as though it was set from webmap.\n       * @param {Object} layerOptions Json hash of layer properties. Either from a webmap\n       * or constructed for a layer in a feature service\n       */\n      _addDefaultSymbols: function(layerOptions){\n          //add the layerDefinition node\n          if(!layerOptions.layerDefinition){\n              layerOptions.layerDefinition = {};\n              layerOptions.layerDefinition.drawingInfo = {};\n          }\n          if(!layerOptions.layerDefinition.drawingInfo){\n              layerOptions.layerDefinition.drawingInfo = {};\n          }\n\n          //depending on the type, load in the default renderer as json\n          switch (layerOptions.geometryType){\n              case 'esriGeometryPolygon':\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultPolygonRenderer;\n                  break;\n              case 'esriGeometryPoint':\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultPointRenderer;\n                  break;\n              case 'esriGeometryMultipoint':\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultPointRenderer;\n                  break;\n              case 'esriGeometryPolyline':\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultLineRenderer;\n                  break;\n              case 'esriGeometryLine':\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultLineRenderer;\n                  break;\n              default: \n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultPolygonRenderer;\n          }\n          return layerOptions;\n      },\n\n      _createRendererFromJson: function(rendererJson){\n          var renderer;\n          switch (rendererJson.type){\n              case 'simple':\n                  //create the default symbol\n                  renderer = new esri.renderer.SimpleRenderer(rendererJson);\n                  break;\n              case 'classBreaks':\n                  renderer = new esri.renderer.ClassBreaksRenderer(rendererJson);\n                  break;\n          }\n          return renderer;\n      }\n\n      \n    });\n\n  });\n})();\nif (!this.util || typeof this.util !== 'object') {\n    this.util = {};\n}\n\nutil.defaults = {\n\n  extent:  {\n    'xmin': -24140227.55632808,\n    'ymin': 2529400.5847910205,\n    'xmax': 13430100.586391762,\n    'ymax': 8399764.357090997,\n    'spatialReference': {\n      'wkid': 102100\n    }\n  },\n\n  serviceUrls: {\n    'geometryService': { \n      'url': 'http://utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer' \n    }\n  },\n  /**\n   * Default Point Renderer for Composer\n   * @return {Object} Json Renderer\n   */   \n  defaultPointRenderer : {\n    'type': 'simple',\n    'label': '',\n    'description': '',\n    'symbol': {\n      'color': [49,130,189,225],\n      'size': 6,\n      'angle': 0,\n      'xoffset': 0,\n      'yoffset': 0,\n      'type': 'esriSMS',\n      'style': 'esriSMSCircle',\n      'outline': {\n        'color': [220,220,220,255],\n        'width': 0.6,\n        'type': 'esriSLS',\n        'style': 'esriSLSSolid'\n      }\n    }\n  },\n\n  /**\n   * Default Line Renderer for Composer\n   * @return {Object} Json Renderer\n   */\n  defaultLineRenderer :  {\n    'type': 'simple',\n    'symbol': {\n      'color': [0,122,194,255],\n      'width': 2,\n      'type': 'esriSLS',\n      'style': 'esriSLSSolid'\n    }\n  },\n\n  /**\n   * Default Polygon Renderer for Composer\n   * @return {Object} Json Renderer\n   */\n  defaultPolygonRenderer :{\n    'type': 'simple',\n    'symbol': {\n      'color': [49,130,189,225],\n      'outline': {\n        'color': [220,220,220,255],\n        'width': 0.6,\n        'type': 'esriSLS',\n        'style': 'esriSLSSolid'\n      },\n      'type': 'esriSFS',\n      'style': 'esriSFSSolid'\n    }\n  }\n};\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Base', function (Base, App, Backbone, Marionette, $, _) {\n\n    Base.SearchView = Marionette.ItemView.extend({ \n\n      onRender: function(){\n        this.initTypeahead();\n      },\n\n      initTypeahead: function () {\n        var self = this;\n\n        var opts = {\n          highlight: true,\n          minLength: 3,\n          hint: false\n        };\n\n        //by putting it on app instead of this base view, we can share one instance throughout the app\n        //instead of having one instance per view that needs one\n        var bloodhound = App.getBloodhound();\n        bloodhound.initialize();\n\n        var datasets = {\n          name: 'datasets',\n          displayKey: function(item) {\n            return item;\n          },\n          templates: {\n            empty: ''\n          },\n          source: bloodhound.ttAdapter()\n        };\n\n        this.ui.search.typeahead(opts, datasets);\n      },\n\n      onTypeaheadSelected: function (e) {\n        //clicking a selection with the mouse should initiate a search  \n        this.model.set({\n          q: this.ui.search.typeahead('val'),\n          page: 1\n        });\n\n        this.search();\n      },\n\n      updateModel: function () {\n        var q = this.ui.search.typeahead('val');\n        this.model.set({\n          q: q,\n          page: 1\n        });\n      },\n\n      onKeyDown:function(e){\n        if (e.which === 13) {\n          e.preventDefault();\n\n          this.ui.search.typeahead('close');\n\n          this.updateModel();\n\n          this.search();\n        }\n      },\n\n      onKeyUp: function () {\n        this.updateModel();\n      },\n\n      onSearchButtonClick: function () {\n        this.updateModel();\n        this.search();\n      },\n\n      search: function () {\n        App.search();\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n         \n    /*\n    * Models search parameters and uses them to generate search urls\n    */\n    Models.SearchModel = Backbone.Model.extend({ \n\n      defaults: {\n        q: '',\n        page: 1,\n        per_page: 20,\n        total_count: 0,\n        sort_by: 'relevance'\n      },\n\n      queryStringParams: [ 'q', 'page', 'per_page', 'sort_by' ],\n\n      getQueryString: function () {\n        //create an object containing only the attributes we need to generate the querystring\n        var obj = _.pick(this.toJSON(), this.queryStringParams);\n        //generate querystring parameters from the object\n        return $.param(obj);\n      },\n\n      getRoute: function (api) {\n        // we use this function to generate routes within the app\n        // AND to generate api urls - hence the api parameter\n        \n        var route = 'datasets';\n        route += (api) ? '.json?' : '?';\n        route += this.getQueryString();\n        return route;\n      },\n\n      getUrl: function () {\n        return App.config.api + this.getRoute(true);\n      }\n\n    });\n\n  });\n\n})();\n\nMyOD.config = {\n  //api: '//umb.dcdev.opendata.arcgis.com/'\n  //api: '//data3.dc.opendataqa.arcgis.com/'\n  //api: '//umb.dcdev.staging.datacommunity.io/'\n  //api: '//clt.charlotte.opendata.arcgis.com/'\n  api: '//opendataqa.arcgis.com/'\n};\nthis.JST = {\"datasets/templates/dataset\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<div class=\"clearfix\">\\n  <h2 class=\"pull-left clearfix\"><img class=\"img-thumbnail\" src=\"' +\n((__t = ( thumbnail_url )) == null ? '' : __t) +\n'\"><span>' +\n((__t = ( name )) == null ? '' : __t) +\n'</span></h2>\\n  <div class=\"dropdown pull-right\">\\n    <button class=\"btn btn-primary\" type=\"button\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">\\n      Download\\n      <span class=\"caret\"></span>\\n    </button>\\n    <ul class=\"dropdown-menu\" role=\"menu\" aria-labelledby=\"dLabel\">\\n      <li><a href=\"' +\n((__t = ( baseUrl )) == null ? '' : __t) +\n'.csv\" target=\"_blank\" download>Spreadsheet</a></li>\\n      <li><a href=\"' +\n((__t = ( baseUrl )) == null ? '' : __t) +\n'.kml\" target=\"_blank\" download>KML</a></li>\\n      <li><a href=\"' +\n((__t = ( baseUrl )) == null ? '' : __t) +\n'.zip\" target=\"_blank\" download>Shapefile</a></li>\\n      <li class=\"divider\"></li>\\n      <li><a href=\"' +\n((__t = ( arcgis_online_item_url )) == null ? '' : __t) +\n'\" target=\"_blank\">View in ArcGIS Online</a></li>\\n      <li><a href=\"' +\n((__t = ( url )) == null ? '' : __t) +\n'\" target=\"_blank\">API</a></li>\\n    </ul>\\n  </div>\\n</div>\\n\\n<div class=\"container\">\\n  <div class=\"row\">\\n    <div class=\"col-lg-6 col-md-6\">\\n      <h4>Description</h4>\\n      <p>' +\n((__t = ( description )) == null ? '' : __t) +\n'</p>\\n      \\n    </div>\\n    <div class=\"col-lg-6 col-md-6\">\\n      <dl class=\"dl-horizontal\">\\n        \\n        <dt>Owner:</dt>\\n        <dd>' +\n((__t = ( owner )) == null ? '' : __t) +\n'</dd>\\n\\n        <dt>Created:</dt>\\n        <dd>' +\n((__t = ( moment(created_at).calendar() )) == null ? '' : __t) +\n'</dd>\\n        \\n        <dt>Updated:</dt>\\n        <dd>' +\n((__t = ( moment(updated_at).calendar() )) == null ? '' : __t) +\n'</dd>\\n\\n        <dt>Tags:</dt>\\n        <dd>' +\n((__t = ( tags.join(' | ') )) == null ? '' : __t) +\n'</dd>\\n        \\n        <dt>Views:</dt>\\n        <dd>' +\n((__t = ( views )) == null ? '' : __t) +\n'</dd>\\n\\n      </dl>\\n    </div>\\n\\n\\n  </div>\\n</div>\\n\\n\\n<div class=\"container\">\\n  <div id=\"map\"></div>\\n  <div id=\"smaps\">\\n    <div class=\"container\"></div>\\n  </div>\\n</div>\\n\\n<div id=\"table-container\" class=\"container\"></div>\\n';\n\n}\nreturn __p\n},\n\"datasets/templates/table-row\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape, __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\nwith (obj) {\n\n _.each(fields, function (field) { ;\n__p += '\\n  <td>' +\n((__t = ( attributes[field.name] )) == null ? '' : __t) +\n'</td>\\n';\n }); ;\n__p += '\\n';\n\n}\nreturn __p\n},\n\"datasets/templates/table\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape, __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\nwith (obj) {\n__p += '<h4>Showing ' +\n((__t = ( from.toLocaleString() )) == null ? '' : __t) +\n' to ' +\n((__t = ( to.toLocaleString() )) == null ? '' : __t) +\n' of ' +\n((__t = ( total.toLocaleString() )) == null ? '' : __t) +\n'</h4>\\n<div class=\"table-responsive\">  \\n  <table class=\"table table-striped table-bordered table-hover\">\\n    <thead>\\n      <tr>\\n        ';\n _.each(fields, function (field) { ;\n__p += '\\n          ';\n if (sortField === field.name) { ;\n__p += '\\n            <th data-field-name=\"' +\n((__t = ( field.name )) == null ? '' : __t) +\n'\" class=\"' +\n((__t = ( sortClass )) == null ? '' : __t) +\n'\">\\n              ' +\n((__t = ( field.alias || field.name )) == null ? '' : __t) +\n'\\n              <span class=\"glyphicon small ' +\n((__t = ( sortIconClass )) == null ? '' : __t) +\n' text-muted\" aria-hidden=\"true\"></span>\\n            </th>\\n          ';\n } else { ;\n__p += '\\n            <th data-field-name=\"' +\n((__t = ( field.name )) == null ? '' : __t) +\n'\">\\n              ' +\n((__t = ( field.alias || field.name )) == null ? '' : __t) +\n'\\n            </th>\\n          ';\n } ;\n__p += '\\n        ';\n }); ;\n__p += '\\n      </tr>\\n    </thead>\\n    <tbody></tbody>\\n  </table>\\n</div>\\n<nav>\\n  <ul class=\"pagination\">\\n    ';\n if (pages.length > 1) { ;\n__p += '\\n      <li id=\"page-prev\" class=\"' +\n((__t = ( firstPage )) == null ? '' : __t) +\n'\"><a data-page=\"' +\n((__t = ( prevPage )) == null ? '' : __t) +\n'\"><span aria-hidden=\"true\">&laquo;</span></a></li>\\n      \\n      ';\n _.each(pages, function (page) { ;\n__p += '\\n        <li class=\"' +\n((__t = ( page.active )) == null ? '' : __t) +\n'\"><a class=\"page-number\" data-page=\"' +\n((__t = ( page.page )) == null ? '' : __t) +\n'\">' +\n((__t = ( page.page )) == null ? '' : __t) +\n'</a></li>\\n      ';\n }); ;\n__p += '\\n\\n      <li id=\"page-next\" class=\"' +\n((__t = ( lastPage )) == null ? '' : __t) +\n'\"><a data-page=\"' +\n((__t = ( nextPage )) == null ? '' : __t) +\n'\"><span aria-hidden=\"true\">&raquo;</span></a></li>\\n    ';\n } ;\n__p += '\\n  </ul>\\n</nav>';\n\n}\nreturn __p\n},\n\"error/templates/404\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<div class=\"alert alert-danger\" role=\"alert\">\\n  <h2>The page you are looking for doesn\\'t exist.</h2>\\n</div>\\n';\n\n}\nreturn __p\n},\n\"error/templates/500\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<div class=\"alert alert-danger\" role=\"alert\">\\n  <h2>An error ocurred.</h2>\\n</div>\\n';\n\n}\nreturn __p\n},\n\"home/templates/home\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '\\n<div class=\"jumbotron\" id=\"hero\">\\n  <h1 class=\"page-header\">My Open Data</h1>\\n  <p>\\n    <div class=\"input-group input-group-lg\">\\n      <label class=\"sr-only\" for=\"search\">Search</label>\\n      <input type=\"search\" name=\"search\" id=\"search\" class=\"form-control\" placeholder=\"search for open data\">\\n      <span class=\"input-group-btn\">\\n        <button id=\"search-btn\" class=\"btn btn-default\" type=\"button\">\\n          <span class=\"glyphicon glyphicon-search\" aria-hidden=\"true\"></span>\\n        </button>\\n      </span>\\n    </div>\\n  </p>\\n  <span style=\"float:right;color:#FFF\">Image <a href=\"https://www.flickr.com/photos/davebloggs007/14389618573\">CC Dave Bloggs</a></span>\\n</div>\\n<div class=\"row\">\\n  \\n</div>\\n';\n\n}\nreturn __p\n},\n\"results/templates/results-empty\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<td colspan=\"7\" class=\"text-center\">...</td>';\n\n}\nreturn __p\n},\n\"results/templates/results-item\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<td>' +\n((__t = ( name )) == null ? '' : __t) +\n'</td>\\n<td>' +\n((__t = ( owner )) == null ? '' : __t) +\n'</td>\\n<td>' +\n((__t = ( record_count )) == null ? '' : __t) +\n'</td>\\n<td>' +\n((__t = ( item_type )) == null ? '' : __t) +\n'</td>\\n<td>' +\n((__t = ( views )) == null ? '' : __t) +\n'</td>\\n<td>' +\n((__t = ( moment(created_at).fromNow() )) == null ? '' : __t) +\n'</td>\\n<td>' +\n((__t = ( moment(updated_at).fromNow() )) == null ? '' : __t) +\n'</td>';\n\n}\nreturn __p\n},\n\"results/templates/results-loading\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<td colspan=\"7\" class=\"text-center\">\\n  <div class=\"progress\">\\n    <div class=\"progress-bar progress-bar-striped active\" role=\"progressbar\" aria-valuenow=\"40\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: 45%\">\\n      <span class=\"sr-only\">45% Complete</span>\\n    </div>\\n  </div>\\n</td>';\n\n}\nreturn __p\n},\n\"results/templates/results\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape, __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\nwith (obj) {\n__p += '<h2>\\n  ';\n if (!collectionIsLoading) { ;\n__p += '\\n    Your search for <em>\"' +\n((__t = ( q )) == null ? '' : __t) +\n'\"</em> yielded ' +\n((__t = ( total_count.toLocaleString() )) == null ? '' : __t) +\n' datasets\\n  ';\n } ;\n__p += '\\n</h2>\\n\\n<div class=\"table-responsive\">  \\n  <table class=\"table table-striped table-bordered table-hover\">\\n    <thead>\\n      <tr>\\n        <th>NAME</th>\\n        <th>OWNER</th>\\n        <th>RECORDS</th>\\n        <th>LAYER TYPE</th>\\n        <th>VIEWS</th>\\n        <th>CREATED</th>\\n        <th>UPDATED</th>\\n      </tr>\\n    </thead>\\n    <tbody></tbody>\\n  </table>\\n</div>\\n<nav>\\n  <ul class=\"pagination\">\\n    ';\n if (pages.length > 1) { ;\n__p += '\\n      <li id=\"page-prev\" class=\"' +\n((__t = ( firstPage )) == null ? '' : __t) +\n'\"><a href=\"#' +\n((__t = ( prevUrl )) == null ? '' : __t) +\n'\" data-page=\"' +\n((__t = ( prevPage )) == null ? '' : __t) +\n'\"><span aria-hidden=\"true\">&laquo;</span></a></li>\\n      \\n      ';\n _.each(pages, function (page) { ;\n__p += '\\n        <li class=\"' +\n((__t = ( page.active )) == null ? '' : __t) +\n'\"><a href=\"#' +\n((__t = ( page.url )) == null ? '' : __t) +\n'\" class=\"page-number\" data-page=\"' +\n((__t = ( page.page )) == null ? '' : __t) +\n'\">' +\n((__t = ( page.page )) == null ? '' : __t) +\n'</a></li>\\n      ';\n }); ;\n__p += '\\n\\n      <li id=\"page-next\" class=\"' +\n((__t = ( lastPage )) == null ? '' : __t) +\n'\"><a href=\"#' +\n((__t = ( nextUrl )) == null ? '' : __t) +\n'\" data-page=\"' +\n((__t = ( nextPage )) == null ? '' : __t) +\n'\"><span aria-hidden=\"true\">&raquo;</span></a></li>\\n    ';\n } ;\n__p += '\\n  </ul>\\n</nav>';\n\n}\nreturn __p\n}};\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Main', function (Main, App, Backbone, Marionette, $, _) {\n          \n    Main.HeaderSearchView = MyOD.Base.SearchView.extend({ \n\n      initialize: function () {\n        this.listenTo(this.model, 'change:q', this.onQueryChanged);\n      },\n\n      el: '#header-search-container',\n\n      template: false,\n\n      events: {\n        'keydown #header-search': 'onKeyDown',\n        'keyup #header-search': 'onKeyUp',\n        'click #header-search-btn': 'onSearchButtonClick',\n        'typeahead:selected input': 'onTypeaheadSelected'\n      },\n\n      ui: {\n        search: '#header-search'\n      },\n\n      onQueryChanged: function () {\n        this.ui.search.typeahead('val', this.model.get('q'));\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Main', function (Main, App, Backbone, Marionette, $, _) {\n\n    Main.Layout = Marionette.LayoutView.extend({\n      \n      initialize: function () {\n        _.bindAll(this, 'setClasses');\n        this.headerSearchView = new Main.HeaderSearchView({ model: App.searchModel }).render();\n      },\n\n      el: 'body',\n\n      regions: {\n        main: '#main-region'\n      },\n\n      events: {\n        'click #home-link': 'navigateHome'\n      },\n\n      navigateHome: function (e) {\n        if (!e.metaKey && !e.ctrlKey) {\n          e.preventDefault();\n          App.navigate('', { trigger: true });\n        }\n      },\n\n      setClasses: function () {\n        var self = this;\n        if (Backbone.history.getFragment().indexOf('datasets') === 0) {\n          self.$el.removeClass('page-home');\n        } else {\n          self.$el.addClass('page-home');\n        }\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('HomeModule', function (HomeModule, App, Backbone, Marionette, $, _) {\n          \n    HomeModule.View = MyOD.Base.SearchView.extend({ \n\n      initialize: function () {\n        this.model = App.searchModel;   \n      },\n\n      template: JST['home/templates/home'],\n\n      events: {\n        'keydown #search': 'onKeyDown',\n        'keyup #search': 'onKeyUp',\n        'click #search-btn': 'onSearchButtonClick',\n        'typeahead:selected input': 'onTypeaheadSelected'\n      },\n\n      ui: {\n        search: '#search'\n      },\n\n      id: 'home',\n\n      onDomRefresh: function () {\n        this.ui.search.focus();\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('HomeModule', function (HomeModule, App, Backbone, Marionette, $, _) {\n          \n    HomeModule.Controller = Marionette.Controller.extend({ \n\n      initUi: function () {\n        var view = new HomeModule.View();\n        App.layout.getRegion('main').show(view);\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('HomeModule', function (HomeModule, App, Backbone, Marionette, $, _) {\n      \n    //Router for the module\n    HomeModule.Router = Backbone.Marionette.AppRouter.extend({\n      appRoutes:{\n        '': 'show'\n      }\n    });\n\n    //Add the router during the initialization \n    HomeModule.addInitializer(function (options) {\n      var router = new HomeModule.Router({ controller: HomeModule.API }); \n    });\n\n    //Simple API object that provides the implementation for the routes\n    HomeModule.API = {\n\n      show: function(options){\n\n        if(!this.homeController){\n          this.homeController = new HomeModule.Controller(options);\n        }\n\n        this.homeController.initUi(options);\n      }\n    };\n\n  });\n})();\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n          \n    /*\n    * Models a dataset\n    */\n    Models.DatasetModel = Backbone.Model.extend({\n\n      defaults: {\n        id: '',\n        name: '',\n        description: '',\n        tags: [],\n        arcgis_online_item_url: '',\n        owner: '',\n        url: '',\n        created_at: '',\n        updated_at: '',\n        views: 0,\n        thumbnail_url: ''\n      },\n\n      parse: function (response) {\n        return response.data || response;\n      },\n\n      url: function () {\n        return MyOD.config.api + 'datasets/' + this.get('id') + '.json';\n      },\n\n      getNumericFields: function () {\n        var fields = this.get('fields');\n        return _.filter(fields, function (item) {\n          return _.contains([ 'esriFieldTypeSingle', 'esriFieldTypeDouble', 'esriFieldTypeInteger' ], item.type);\n        });\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n          \n    /*\n    * Models a collection of datasets\n    */\n    Models.DatasetCollection = Backbone.Collection.extend({\n\n      model: Models.DatasetModel,\n\n      url: function () {\n        return App.searchModel.getUrl(true);\n      },\n\n      parse: function (resp) {\n        //apply the metadata to the searchmodel\n        App.searchModel.set(_.extend(resp.metadata.query_parameters, resp.metadata.stats));\n        return resp.data;\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('ResultsModule', function (ResultsModule, App, Backbone, Marionette, $, _) {\n\n    ResultsModule.ItemView = Marionette.ItemView.extend({ \n\n      template: JST['results/templates/results-item'],\n\n      model: MyOD.Models.DatasetModel,\n\n      tagName: 'tr',\n\n      events: {\n        click: 'onClick'\n      },\n\n      onClick: function () {\n        this.trigger('result:clicked', this.model);\n      }\n\n    });\n\n    ResultsModule.LoadingView = Marionette.ItemView.extend({ \n\n      template: JST['results/templates/results-loading'],\n\n      tagName: 'tr',\n\n      className: 'loading'\n\n    });\n\n    ResultsModule.EmptyView = Marionette.ItemView.extend({ \n\n      template: JST['results/templates/results-empty'],\n\n      tagName: 'tr'\n\n    });\n\n    ResultsModule.View = Marionette.CompositeView.extend({ \n\n      initialize: function () {\n        this.listenTo(this, 'childview:result:clicked', this.selectDataset);\n      },\n\n      collectionIsLoading: true,\n\n      template: JST['results/templates/results'],\n\n      childView: ResultsModule.ItemView,\n\n      childViewContainer: 'tbody',\n\n      getEmptyView: function () {\n        if (this.collectionIsLoading) {\n          return ResultsModule.LoadingView;\n        } else {\n          return ResultsModule.EmptyView;\n        }\n      },\n\n      events: {\n        'click ul.pagination a': 'onPageClicked'\n      },\n\n      modelEvents: {\n        'change:total_count': 'render'\n      },\n\n      collectionEvents: {\n        'sync': 'onCollectionSync',\n        'error': 'onCollectionSync'\n      },\n\n      id: 'page-results',\n\n      onCollectionSync: function () {\n        this.collectionIsLoading = false;\n        this.render();\n      },\n\n      selectDataset: function (childView, childModel) {\n        App.navigateDataset(childModel.get('id'));\n      },\n\n      onPageClicked: function (e) {\n        //allow cmd-click to open in new window\n        if(!(e.metaKey || e.ctrlKey)){\n          e.stopPropagation();\n          e.preventDefault();\n          var page = $(e.target).closest('a').data('page');\n          //not sure why i was doing it this way...\n          //var model = App.searchModel.clone();\n          //App.navigate(model.getRoute(false), { trigger: true });\n          this.model.set('page', page);\n          App.search();\n        }\n      },\n\n      templateHelpers: function () {\n        //serialize the model into what we need for the template\n        var info = App.searchModel.toJSON();\n\n        var len = Math.round(info.total_count);\n        var page = +info.page;\n        var from = (page === 0) ? page + 1 : page;\n        var size = info.per_page;\n        var total_pages = Math.ceil(len / size);\n        var pages = [];\n        \n        //don't show more than 10?\n        var start = ( total_pages > 10 && from > 6 ) ? from - 5 : 1;\n        var end = ( total_pages > start + 9 ) ? start + 9 : total_pages;\n\n        // build the pages array\n        var searchModel = this.model.clone();\n        var active;\n        for (var i = start; i <= end; i++) {\n          active = (i === from) ? 'active' : '';\n          searchModel.set('page', i);\n          pages.push({ url: searchModel.getRoute(false), page: i, active: active });\n        }\n\n        var prevUrl = this.model.getRoute(false);\n        var prevPage = page;\n        if (from !== 1) { \n          prevPage = page-1;\n          searchModel.set('page', prevPage);\n          prevUrl = searchModel.getUrl();\n        }\n        var nextUrl = this.model.getRoute(false);\n        var nextPage = page;\n        if (total_pages !== from) {\n          nextPage = page + 1;\n          searchModel.set('page', nextPage);\n          nextUrl = searchModel.getUrl();\n        }\n\n        return {\n          firstPage: (from === 1) ? 'disabled' : '',\n          lastPage: (total_pages === from) ? 'disabled' : '',\n          prevUrl: prevUrl,\n          nextUrl: nextUrl,\n          prevPage: prevPage,\n          nextPage: nextPage,\n          pages: pages,\n          collectionIsLoading: this.collectionIsLoading\n        };\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('ResultsModule', function (ResultsModule, App, Backbone, Marionette, $, _) {\n          \n    ResultsModule.Controller = Marionette.Controller.extend({ \n\n      initUi: function (options) {\n        this.collection = new App.Models.DatasetCollection();\n        this.collection.fetch({ cache: true });\n        this.view = new ResultsModule.View({ model: App.searchModel, collection: this.collection });\n        App.layout.getRegion('main').show(this.view);\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('ResultsModule', function (ResultsModule, App, Backbone, Marionette, $, _) {\n      \n    //Router for the module\n    ResultsModule.Router = Backbone.Marionette.AppRouter.extend({\n      appRoutes:{\n        'datasets(/)': 'show'\n      }\n    });\n\n    //Add the router during the initialization \n    ResultsModule.addInitializer(function (options) {\n      var router = new ResultsModule.Router({ controller: ResultsModule.API }); \n    });\n\n    //Simple API object that provides the implementation for the routes\n    ResultsModule.API = {\n\n      show: function(options){\n\n        var queryObj = App.queryStringToObject();\n        //don't encode the q\n        // var q = App.searchModel.get('q');\n        // App.searchModel.set(_.extend(queryObj, { q: q }));\n        App.searchModel.set(queryObj);\n\n        if(!this.resultsController){\n          this.resultsController = new ResultsModule.Controller(options);\n        }\n\n        this.resultsController.initUi(options);\n      }\n\n    };\n\n  });\n})();\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n          \n    /*\n    * Models a single record in a dataset\n    */\n    Models.DatasetRow = Backbone.Model.extend({\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\n    \n    /*\n    * Models a collection of records in a dataset\n    */\n    Models.RowCollection = Backbone.Collection.extend({\n\n      initialize: function (attributes, options) {\n        this.dataset = options.dataset;\n        \n        var queryCapabilities = this.dataset.get('advanced_query_capabilities');\n        this.supportsPagination = queryCapabilities && queryCapabilities.supports_pagination;\n\n        this.orderBy = this.dataset.get('object_id_field');\n      },\n\n      perPage: 10,\n\n      page: 0,\n\n      orderBy: '',\n\n      orderByAsc: true,\n\n      model: Models.DatasetRow,\n\n      getQueryUrl: function () {\n        var url = this.dataset.get('url');\n        url += '/query?where=1%3D1&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=false&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&f=pjson';\n\n        if (this.supportsPagination) {\n          url += '&resultOffset=' + this.page * this.perPage;\n          url += '&resultRecordCount=' + this.perPage;\n          //NOTE: when you pass in one of the above two parameters and orderByFields is left empty, \n          //map service uses the object-id field to sort the result. \n          //For a query layer with a pseudo column as the object-id field (e.g., FID), \n          //you must provide orderByFields; otherwise the query fails\n        }\n\n        var orderBy = this.orderBy;\n        if (!this.orderByAsc) {\n          orderBy += ' desc';\n        }\n        //NOTE: this still could fail \n        //if the oid field has changed since it was harvested by open data\n        //or it is null (which should not happen...)\n        url += '&orderByFields=' + orderBy;\n\n        return url;\n      },\n\n      url: function () {\n        return this.getQueryUrl();\n      },\n\n      parse: function (resp) {\n        // this.fields = resp.fields;\n        // this.fieldAliases = resp.fieldAliases;\n        var rows = resp.features;\n        if (!this.supportsPagination) {\n          //this is slightly crappy but \n          //for datasets that don't support pagination\n          //we just show the first n rows with no pagination\n          //even though we got maxRecordCount rows\n          rows = _.first(rows, this.perPage);\n        }\n        return rows;\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\n         \n    DatasetsModule.TableRowView = Marionette.ItemView.extend({ \n\n      initialize: function (options) {\n        this.dataset = options.dataset;\n        this.fields = this.dataset.get('fields');\n      },\n\n      template: JST['datasets/templates/table-row'],\n\n      templateHelpers: function () {\n        var self = this;\n        return {\n          fields: self.fields\n        };\n      },\n\n      model: MyOD.Models.DatasetRow,\n\n      tagName: 'tr'\n\n    });\n\n    DatasetsModule.TableView = Marionette.CompositeView.extend({\n\n      initialize: function (options) {\n        this.collection = new App.Models.RowCollection([], { dataset: this.model });\n        this.collection.fetch();\n      },\n\n      events: {\n        'click ul.pagination li a': 'onPageClicked',\n        'click thead th': 'sort'\n      },\n\n      collectionEvents: {\n        //we need the pagination to re-render\n        'reset': 'render'\n      },\n\n      template: JST['datasets/templates/table'],\n\n      childView: DatasetsModule.TableRowView,\n\n      childViewOptions: function () {\n        var dataset = this.model;\n        return {\n          dataset: dataset\n        };\n      },\n\n      templateHelpers: function () {\n\n        //defaults - this is what will be rendered if the dataset does not support pagination\n        var obj = {\n          firstPage: '',\n          lastPage: '',\n          prevPage: 0,\n          nextPage: 0,\n          pages: [],\n          showPagination: false,\n          from: 1,\n          to: this.collection.perPage,\n          total: this.model.get('record_count'),\n          sortField: this.collection.orderBy,\n          sortClass: this.collection.orderByAsc ? 'sort_asc' : 'sort_desc',\n          sortIconClass: this.collection.orderByAsc ? 'glyphicon-chevron-down' : 'glyphicon-chevron-up',\n        };\n\n        if (this.collection.supportsPagination) {\n          var totalPages = Math.ceil(this.model.get('record_count') / this.collection.perPage);\n          //zero based page index\n          var page = this.collection.page;\n\n          //don't show more than 10 pages in paginator?\n          var start = (totalPages > 10 && page > 6) ? page - 5 : 1;\n          var end = (totalPages > start + 9) ? start + 9 : totalPages;\n\n          var active, pages = [];\n          for (var i = start; i <= end; i++) {\n            active = (i === page + 1) ? 'active' : '';\n            pages.push({ page: i, active: active });\n          }\n\n          var total = this.model.get('record_count');\n          var from = page * this.collection.perPage + 1;\n          var to = page * this.collection.perPage + this.collection.perPage;\n          to = (to <= total) ? to : total;\n\n          obj = {\n            firstPage: (page === 0) ? 'disabled' : '',\n            lastPage: (totalPages === page + 1) ? 'disabled' : '',\n            prevPage: page,\n            nextPage: page + 2,\n            pages: pages,\n            showPagination: true,\n            from: from,\n            to: to,\n            total: total,\n            sortField: this.collection.orderBy,\n            sortClass: this.collection.orderByAsc ? 'sort_asc' : 'sort_desc',\n            sortIconClass: this.collection.orderByAsc ? 'glyphicon-chevron-down' : 'glyphicon-chevron-up',\n          };\n        }\n\n        return obj;\n      },\n\n      childViewContainer: 'tbody',\n\n      onPageClicked: function (e) {\n        var anchor = $(e.target).closest('a');\n        var li = anchor.closest('li');\n        if (!li.hasClass('disabled') && !li.hasClass('active')) {\n          var page = anchor.data('page') - 1;\n          this.collection.page = page;\n          this.collection.fetch({ reset: true });\n        }\n      },\n\n      sort: function (e) {\n        var orderBy = $(e.target).data('fieldName');\n        if (orderBy) {\n          if (orderBy === this.collection.orderBy) {\n            this.collection.orderByAsc = !this.collection.orderByAsc;\n          } else {\n            this.collection.orderByAsc = true;\n          }\n          this.collection.page = 0;\n          this.collection.orderBy = orderBy;\n          this.collection.fetch({ reset: true });\n        }\n      }\n      \n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\n          \n    DatasetsModule.View = Marionette.ItemView.extend({\n\n      initialize: function (options) {\n        _.bindAll(this, 'changeAttribute', 'changeRamp');\n        this.mapManager = options.mapManager;\n      },\n\n      template: JST['datasets/templates/dataset'],\n\n      id: 'page-dataset',\n\n      ui: {\n        'mapDiv': '#map',\n        'tableContainer': '#table-container'\n      },\n\n      modelEvents: {\n        'change': 'render'\n      },\n\n      templateHelpers: function () {\n        var baseUrl = this.model.url().replace(/.json$/, '');\n        return {\n          baseUrl: baseUrl \n        };\n      },\n\n      onRender: function () {\n        //TODO: refactor to use regions...\n        this.tableView = new DatasetsModule.TableView({ el: this.ui.tableContainer, model: this.model }).render();\n      },\n\n      // onShow: function () {\n      //   console.debug('onShow');\n      // },\n\n      onDomRefresh: function () {\n        if (this.model.get('item_type').toLowerCase() !== 'table') {\n          var self = this;\n          // TODO: would be nice to encapsulate this in mapmanager so consumers wouldn't have to know to do it\n          this.ui.mapDiv.show();\n          this.mapManager.dojoReady.done(function () {\n            self.mapManager.createMap('map', { coords: self.model.get('extent').coordinates });\n            self.mapManager.addDataset(self.model);\n\n            //self.initSmaps();\n          });\n        }\n      },\n\n      initSmaps: function (basemap) {\n        var numerics = this.model.getNumericFields();\n\n        if (numerics.length){\n\n          // select the first attr to map \n          // we could put some logic around which to use here\n          this.fieldName = this.fieldName || numerics[0].name;\n          \n          //get stats for selected attribute\n          var fields = this.model.get('fields');\n          this.stats = this.getStats(fields, this.fieldName);\n          this.type = this.getGeometryType(this.model.get('geometry_type'));\n\n\n          var yukiOptions = {\n            fields: numerics,\n            field: this.fieldName,\n            statistics: this.stats,\n            type: this.type,\n            schemes: this.getSchemes()\n          };\n\n          if (!this.yuki) {\n            this.yuki = new Yuki('smaps', yukiOptions);\n          } else {\n            $('#yuki-viz-tools').remove();\n            this.yuki = new Yuki('smaps', yukiOptions);\n          }\n\n          // EVENT Handlers from yuki\n          this.yuki.on('change', this.changeAttribute);\n          this.yuki.on('ramp-change', this.changeRamp);\n\n          this._execStyleMap();\n        }\n\n      },\n\n      getStats: function (fields, fieldName) {\n        var fieldObj = _.findWhere(fields, { name: fieldName });\n        return fieldObj ? fieldObj.statistics : null;\n      },\n\n      getGeometryType: function (geomType) {\n        switch (geomType) {\n          case 'esriGeometryPoint':\n          case 'esriGeometryMultipoint':\n            return 'point';\n          case 'esriGeometryPolyline':\n            return 'line';\n          case 'esriGeometryPolygon':\n            return 'polygon';\n          default:\n            return geomType.toLowerCase();\n        }\n      },\n\n      getSchemes: function (){\n        var theme, styleType, self = this;\n        switch (this.type){\n          case 'point':\n            theme = 'default';\n            styleType = 'size';\n            break;\n          case 'polygon':\n            theme = 'high-to-low';\n            styleType = 'choropleth';\n            break;\n        }\n\n        //TODO: move this into mapmanager\n        return esri.styles[styleType].getSchemes({\n          theme: theme, \n          basemap: 'dark-gray', \n          geometryType: self.type\n        });\n      },\n\n      // handler for attr change \n      changeAttribute: function (fieldName) {\n        //update stats for selected attribute\n        var fields = this.model.get('fields');\n        this.stats = this.getStats(fields, fieldName);\n        this.fieldName = fieldName;\n\n        this._execStyleMap(this.selectedScheme);\n      },\n\n      // handler for ramp UI change\n      changeRamp: function (index) {\n        this.selectedScheme = this.getSchemes().secondarySchemes[index];\n        this._execStyleMap(this.selectedScheme);\n      },\n\n      //update the map in mapmanager\n      _execStyleMap: function (scheme) {\n        var self = this;\n\n        var opts = {\n          field: this.fieldName,\n          basemap: 'dark-gray',\n          statistics: this.stats,\n          type: this.type\n        };\n      \n        if (scheme){\n          opts.scheme = scheme;\n        }\n        \n        var foo = App.reqres.request('smaps:update:style', opts)\n          .done(function(renderer){\n            if (self.type === 'point'){\n              self.yuki.buildPointLegend(renderer.breaks);\n            }\n          });\n      },\n\n      onDestroy: function () {\n        this.mapManager.destroy();\n        this.tableView.destroy();\n      }\n      \n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\n\n    DatasetsModule.Controller = Marionette.Controller.extend({ \n\n      initialize: function () {\n        _.bindAll(this, 'onModelFetched');\n      },\n\n      initUi: function (options) {\n        this.mapManager = new App.Utils.MapManager();\n        this.model = new App.Models.DatasetModel({ id: options });\n        this.model\n          .fetch()\n            .done(this.onModelFetched)\n            .fail(function () {\n              App.navigate404();\n            });\n      },\n\n      onModelFetched: function () {\n        var view = new DatasetsModule.View({ model: this.model, mapManager: this.mapManager });\n        App.layout.getRegion('main').show(view);\n      },\n\n      onBeforeDestroy: function () {\n        if (this.mapManager) {\n          this.mapManager.destroy();\n        }\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\n      \n    //Router for the module\n    DatasetsModule.Router = Backbone.Marionette.AppRouter.extend({\n      appRoutes:{\n        'datasets/:id(/)': 'show',\n      }\n    });\n\n    //Add the router during the initialization \n    DatasetsModule.addInitializer(function (options) {\n      var router = new DatasetsModule.Router({ controller: DatasetsModule.API }); \n    });\n\n    //Simple API object that provides the implementation for the routes\n    DatasetsModule.API = {\n\n      show: function(options){\n\n        if(!this.datasetsController){\n          this.datasetsController = new DatasetsModule.Controller(options);\n        }\n\n        this.datasetsController.initUi(options);\n      }\n    };\n\n  });\n})();\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('ErrorModule', function (ErrorModule, App, Backbone, Marionette, $, _) {\n          \n    ErrorModule.View = Marionette.ItemView.extend({\n      \n      id: 'page-error',\n\n      getTemplate: function(){\n        var errorCode = this.model.get('errorCode');\n        var template;\n\n        switch (errorCode) {\n          case 404:\n            template = JST['error/templates/404'];\n            break;\n          default:\n            template = JST['error/templates/500'];\n        }\n\n        return template;\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n\n  'use strict';\n    \n  MyOD.module('ErrorModule', function (ErrorModule, App, Backbone, Marionette, $, _) {\n\n    ErrorModule.Controller = Marionette.Controller.extend({ \n\n      initUi: function (options) {\n        // init the results view in here so it re-binds on \"back button\"\n        var model = new Backbone.Model({ errorCode: options.errorCode });\n        var view = new ErrorModule.View({ model: model });\n\n        App.layout.getRegion('main').show(view);\n      }\n\n    });\n\n  });\n\n})();\n\n\n(function () {\n    \n  'use strict';\n\n  MyOD.module('ErrorModule', function (ErrorModule, App, Backbone, Marionette, $, _) {\n      \n    //Router for the module\n    ErrorModule.Router = Backbone.Marionette.AppRouter.extend({\n      appRoutes:{\n        '404': 'error404',\n        '500': 'error500'\n      }\n    });\n\n    //Add the router during the initialization \n    ErrorModule.addInitializer(function (options) {\n      var router = new ErrorModule.Router({ controller: ErrorModule.API }); \n    });\n\n    //Simple API object that provides the implementation for the routes\n    ErrorModule.API = {\n\n      initController: function () {\n        if(!this.errorController){\n          this.errorController = new ErrorModule.Controller();\n        }\n      },\n\n      error404: function () {\n        this.initController();\n        this.errorController.initUi({ errorCode: 404 });\n      },\n\n      error500: function () {\n        this.initController();\n        this.errorController.initUi({ errorCode: 500 });\n      }\n    };\n\n  });\n})();\n\n$(function () {\n  'use strict';\n\n  MyOD.start();\n});"],"sourceRoot":"/source/"}